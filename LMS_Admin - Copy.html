<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXB Visa Bridge LMS | Professional Lead Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #06d6a0;
            --danger: #ef476f;
            --warning: #ffd166;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #f0f4f8;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            width: 100%;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 450px;
            padding: 40px;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        
        .login-logo {
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-weight: 700;
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        .login-logo i {
            font-size: 2.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .login-logo p {
            color: var(--gray);
            font-size: 1.1rem;
        }
        
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(67, 97, 238, 0.15);
        }
        
        .btn {
            display: inline-block;
            padding: 15px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            margin-top: 10px;
            font-family: 'Poppins', sans-serif;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(67, 97, 238, 0.4);
        }
        
        .btn-secondary {
            background: var(--secondary);
            box-shadow: 0 4px 10px rgba(114, 9, 183, 0.3);
        }
        
        .btn-secondary:hover {
            background: #6510a0;
            box-shadow: 0 6px 15px rgba(114, 9, 183, 0.4);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
            box-shadow: none;
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
            width: auto;
        }
        
        .lms-wrapper {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
            transition: width 0.3s ease;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0 30px 10px;
        }

        .sidebar-header i {
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
        }

        .sidebar-link i {
            font-size: 1.2rem;
            width: 20px;
            text-align: center;
        }

        .sidebar-link:hover {
            background: var(--light-gray);
            color: var(--dark);
        }

        .sidebar-link.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3);
        }
        
        /* Sidebar Footer */
        .sidebar-footer {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
            position: relative;
        }
        
        .user-profile-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background-color: transparent;
        }

        .user-profile-container:hover {
            background-color: var(--light-gray);
        }
        
        .user-profile-info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .user-profile-info #userEmail {
            font-size: 0.75rem;
            color: var(--gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-footer .user-avatar {
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            flex-shrink: 0;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        /* Custom Language Dropdown */
        .language-dropdown {
            position: relative;
            margin-bottom: 15px;
        }
        .language-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 15px;
            background: var(--light-gray);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            border: 2px solid transparent;
            transition: var(--transition);
        }
        .language-toggle:hover, .language-toggle.open {
             border-color: var(--primary);
             background-color: white;
        }
        .language-toggle .fas {
            transition: transform 0.3s ease;
        }
        .language-toggle.open .fa-chevron-down {
            transform: rotate(180deg);
        }
        .language-options {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 1200;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--light-gray);
            animation: fadeIn 0.2s;
        }
        .language-options.show {
            display: block;
        }
        .language-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark);
            transition: background-color 0.2s ease;
        }
        .language-option:hover {
            background-color: var(--light-gray);
        }
        .language-option .fa-check {
            color: var(--primary);
            visibility: hidden;
        }
        .language-option.selected .fa-check {
            visibility: visible;
        }

        .profile-popover {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 100%;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            z-index: 1200;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--light-gray);
        }

        .profile-popover.show {
            display: block;
            animation: fadeIn 0.2s;
        }

        .popover-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 15px;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--dark);
            font-family: 'Poppins', sans-serif;
        }
        .popover-btn i {
            width: 20px;
            text-align: center;
            color: var(--gray);
        }
        .popover-btn:hover {
            background-color: var(--light-gray);
        }
        .popover-btn.logout-btn:hover {
            background-color: rgba(239, 71, 111, 0.1);
            color: var(--danger);
        }
        .popover-btn.logout-btn:hover i {
            color: var(--danger);
        }

        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .main-header h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        .announcement-banner {
            background-color: var(--warning);
            color: var(--dark);
            padding: 15px 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--box-shadow);
        }
        .announcement-banner i {
            font-size: 1.5rem;
            color: #d97706; /* A darker yellow for the icon */
        }
        
        .admin-badge, .role-badge {
            background: var(--success);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .role-badge.manager { background-color: var(--warning); color: var(--dark); }
        .role-badge.admin { background-color: var(--primary); }
        .role-badge.user { background-color: var(--gray); }
        
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .page.active {
            display: block;
        }
        
        .section-title {
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title h3 {
            font-weight: 600;
            font-size: 1.8rem;
            color: var(--dark);
            position: relative;
            padding-left: 15px;
        }
        
        .section-title h3::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 5px;
            height: 25px;
            background: var(--primary);
            border-radius: 10px;
        }
        
        .form-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--light-gray);
            height: 100%;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 25px;
            align-items: start;
        }
        .settings-grid .form-container h4 {
            font-size: 1.15rem;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        #userManagementSection {
            grid-column: 1 / -1;
        }

        #userManagementSection .responsive-table th, 
        #userManagementSection .responsive-table td {
            padding: 10px 12px;
        }
        #userManagementSection .actions-cell {
            gap: 8px;
        }
        #userManagementSection .status-select {
            padding: 6px 10px;
            min-width: 120px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
            min-width: 200px;
            margin-bottom: 20px;
        }
        
        .conditional-field {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafc;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
            animation: slideDown 0.3s ease;
        }

        .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .radio-option input[type="radio"] {
            margin-right: 10px;
        }
        
        .info-text {
            background: #fff9e6;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border-left: 4px solid var(--warning);
            color: var(--dark);
            font-weight: 500;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid var(--light-gray);
        }

        #cancelEditBtn {
            border-color: var(--danger);
            color: var(--danger);
        }
        #cancelEditBtn:hover {
            background-color: var(--danger);
            color: white;
        }
        
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
            border: 1px solid var(--light-gray);
        }
        
        .responsive-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .responsive-table th, .responsive-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
            white-space: nowrap;
        }

        .responsive-table th {
            background: #f8fafd;
            font-weight: 600;
            color: var(--dark);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .responsive-table tbody tr {
            transition: var(--transition);
        }
        
        .responsive-table tbody tr:hover {
            background: rgba(67, 97, 238, 0.03);
        }
        
        a.whatsapp-link {
            color: var(--primary);
            font-weight: 500;
            text-decoration: none;
        }
         a.whatsapp-link:hover {
            text-decoration: underline;
         }
        
        .visa-tag {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 5px;
        }
        .visa-tag i { margin-right: 5px; }
        
        .visa-visit { background: rgba(6, 214, 160, 0.15); color: #059669; }
        .visa-cancelled { background: rgba(239, 71, 111, 0.15); color: #dc2626; }
        .visa-active { background: rgba(67, 97, 238, 0.15); color: var(--primary); }
        
        .status-badge, .priority-tag {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .priority-low { background-color: #3498db; color: white; }
        .priority-medium { background-color: #f1c40f; color: var(--dark); }
        .priority-high { background-color: #e74c3c; color: white; }

        .status-pending { background: rgba(255, 209, 102, 0.15); color: #d97706; }
        .status-done { background: rgba(6, 214, 160, 0.15); color: #059669; }
        .status-not-agreed { background: rgba(239, 71, 111, 0.15); color: #dc2626; }
        .status-not-visited { background: rgba(156, 163, 175, 0.15); color: #4b5563; }
        
        .actions-cell { display: flex; gap: 10px; }
        .action-btn {
            width: 38px; height: 38px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: var(--light); color: var(--gray);
            border: none; cursor: pointer; transition: var(--transition); font-size: 1rem;
        }
        .action-btn:hover { background: var(--primary); color: white; transform: translateY(-2px); }
        .action-btn.delete-btn:hover { background: var(--danger); }
        .action-btn.edit-btn:hover { background: var(--warning); color: var(--dark); }
        .action-btn.archive-btn:hover { background: var(--secondary); }
        .action-btn.restore-btn:hover { background: var(--success); }
        .action-btn.gemini-btn {
            background: #6f42c1; /* A nice purple for Gemini */
            color: white;
        }
        .action-btn.gemini-btn:hover {
            background: #5a359d;
        }
        .action-btn.notes-btn {
            background: #3498db; /* Blue for notes */
            color: white;
        }
        .action-btn.notes-btn:hover {
            background: #217dbb;
        }


        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: var(--primary);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }
        .info-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--light-gray);
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .info-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .info-card .card-header h4 { font-size: 1.2rem; font-weight: 600; color: var(--dark); }
        .info-card .card-body p { margin-bottom: 10px; color: var(--gray); }
        .info-card .card-body strong { color: var(--dark); font-weight: 500; }
        .info-card .card-footer { margin-top: 20px; border-top: 1px solid var(--light-gray); padding-top: 15px; }

        .toast {
            position: fixed; top: 20px; right: 20px; padding: 18px 26px;
            border-radius: var(--border-radius); color: white; font-weight: 500;
            box-shadow: var(--box-shadow); z-index: 1050; display: flex;
            align-items: center; gap: 12px; transform: translateX(110%); transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { background: var(--success); }
        .toast-error { background: var(--danger); }
        .toast i { font-size: 1.3rem; }
        
        .modal-overlay {
            display: none; position: fixed; z-index: 1001;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fefefe; padding: 30px; border: 1px solid #888;
            width: 90%; max-width: 500px; border-radius: var(--border-radius);
            animation: fadeIn 0.3s; text-align: center;
        }
        .modal-content h3 { margin-bottom: 15px; }
        .modal-content p { margin-bottom: 25px; color: var(--gray); }
        .modal-actions { display: flex; justify-content: center; gap: 15px; }
        .modal-actions .btn { width: auto; min-width: 120px; }

        .llm-modal-content, .notes-modal-content { /* Unified class for LLM generated content modals */
            max-width: 700px;
        }
        .llm-modal-content textarea, .notes-modal-content textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            line-height: 1.5;
            resize: vertical;
            margin-bottom: 20px;
        }
        .notes-list {
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            background: #f9fafc;
        }
        .note-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .note-item:last-child {
            border-bottom: none;
        }
        .note-item p {
            margin-bottom: 5px;
            color: var(--dark);
            font-size: 0.95rem;
        }
        .note-item small {
            color: var(--gray);
            font-size: 0.8rem;
        }
        .notes-modal-content .form-group {
            text-align: left;
        }
        .notes-modal-content .form-group label {
            margin-bottom: 8px;
        }
        .notes-modal-content .form-control {
            margin-bottom: 15px;
        }
        
        .hidden { display: none !important; }
        
        .status-select {
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid var(--light-gray);
            font-size: 0.85rem;
            font-weight: 500;
            background: white;
            cursor: pointer;
            transition: var(--transition);
        }
        .status-select:focus { outline: none; border-color: var(--primary); }
        
        .admin-controls {
            background: #f8fafd;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            border: 1px solid var(--light-gray);
        }
        .admin-controls-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px; /* Add margin for groups */
        }
        .admin-controls-group:last-child {
            margin-bottom: 0;
        }
        .admin-controls-group .form-control, .admin-controls-group .btn { width: auto; margin-top: 0; }
        .admin-controls-group > label { font-weight: 500; }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }
        .dashboard-card {
            background: white; padding: 25px; border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid var(--light-gray);
        }
        
        #companyPriceDisplay {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* Styles for settings sections */
        .settings-content-section {
            margin-bottom: 30px; /* Add margin between sections */
        }
        .settings-content-section:last-of-type {
            margin-bottom: 0; /* No margin after the last section */
        }
        .performance-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .performance-summary-card {
            background: var(--light-gray);
            padding: 20px;
            border-radius: var(--border-radius);
            font-weight: 600;
            color: var(--dark);
        }
        .performance-summary-card h5 {
            font-size: 1rem;
            margin-bottom: 10px;
            color: var(--gray);
        }
        .performance-summary-card p {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">
                <h1><i class="fas fa-chart-line"></i> DXB Visa Bridge LMS</h1>
                <p>Your Professional Lead Management Partner</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn">Sign In</button>
                <div style="margin-top: 20px; text-align: center; color: var(--gray);">
                    <p>
                      <a href="https://instagram.com/zem.4m" target="_blank" style="text-decoration: none; color: inherit;">
                        <i class="fab fa-instagram" style="margin-right: 6px; color: #E1306C;"></i>Developed By Planner Zohaib Sarwar
                      </a>
                    </p>
                </div>
            </form>
        </div>
    </div>
    
    <div class="lms-wrapper hidden" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-chart-line"></i>
                <h2>DXB Bridge</h2>
            </div>
            <nav class="sidebar-nav">
                <a class="sidebar-link active" data-page="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="sidebar-link" data-page="addClientPanel">
                    <i class="fas fa-user-plus"></i> Add Client
                </a>
                <a class="sidebar-link" data-page="clientData">
                    <i class="fas fa-users"></i> Client Data
                </a>
                <a class="sidebar-link admin-only hidden" data-page="archivedData">
                    <i class="fas fa-archive"></i> Archived
                </a>
                 <a class="sidebar-link admin-only hidden" data-page="settingsPanel">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>
            <div class="sidebar-footer">
                <div id="profilePopover" class="profile-popover">
                    <button id="adminSettingsBtn" class="popover-btn admin-only hidden">
                        <i class="fas fa-cogs"></i> Admin Settings
                    </button>
                    <button id="logoutBtn" class="popover-btn logout-btn">
                        <i class="fas fa-power-off"></i> Logout
                    </button>
                </div>

                <div class="language-dropdown">
                    <div id="language-options" class="language-options">
                        <button class="popover-btn language-option" data-lang-value="en">
                            <span>English</span>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="popover-btn language-option" data-lang-value="hi">
                            <span>हिंदी</span>
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="popover-btn language-option" data-lang-value="ar">
                            <span>العربية</span>
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                    <button id="language-toggle" class="language-toggle">
                        <span id="selected-language-text"><i class="fas fa-globe"></i> English</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>

               <div id="userProfileContainer" class="user-profile-container">
                    <div class="user-avatar" id="userAvatar">JD</div>
                    <div class="user-profile-info">
                        <div style="font-weight: 600;" id="userName">John Doe</div>
                        <div id="userEmail"></div>
                    </div>
               </div>
           </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h1 id="pageTitle">Dashboard</h1>
            </header>
            
            <div id="dashboard" class="page active">
                <div id="announcementBanner" class="announcement-banner hidden">
                    <i class="fas fa-bullhorn"></i>
                    <span id="announcementMessage"></span>
                </div>
                <!-- Personal Performance Metrics for All Users -->
                <div class="dashboard-card">
                    <h4 style="margin-bottom: 20px;">Your Performance Summary</h4>
                    <div class="performance-summary-grid">
                        <div class="performance-summary-card">
                            <h5>Leads Added</h5>
                            <p id="userLeadsAdded">0</p>
                        </div>
                        <div class="performance-summary-card">
                            <h5>Leads Done</h5>
                            <p id="userLeadsDone">0</p>
                        </div>
                        <div class="performance-summary-card">
                            <h5>Conversion Rate</h5>
                            <p id="userConversionRate">0%</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <canvas id="visaStatusChart"></canvas>
                    </div>
                    <div class="dashboard-card">
                        <canvas id="overallStatusChart"></canvas>
                    </div>
                    <!-- New Lead Source Distribution Chart -->
                    <div class="dashboard-card">
                        <canvas id="leadSourceChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div id="addClientPanel" class="page">
                <div class="section-title"><h3 id="formTitle" data-lang="addNewLead">Add New Client Lead</h3></div>
                <div class="form-container">
                    <form id="clientForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="clientName" data-lang="clientName">Client Name</label>
                                    <input type="text" id="clientName" class="form-control" placeholder="Enter client name" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="phone" data-lang="phone">Phone Number</label>
                                    <input type="tel" id="phone" class="form-control" placeholder="Enter phone number" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                             <div class="form-col">
                                <div class="form-group">
                                    <label for="nationality" data-lang="nationality">Nationality</label>
                                    <select id="nationality" class="form-control" required>
                                        <option value="">Select Nationality</option>
                                        <option value="India">India</option>
                                        <option value="Pakistan">Pakistan</option>
                                        <option value="Nigerian">Nigerian</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="location" data-lang="location">Location</label>
                                    <select id="location" class="form-control" required>
                                        <option value="">Select Location</option>
                                        <option value="Inside UAE">Inside UAE</option>
                                        <option value="Outside UAE">Outside UAE</priority>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                           <div class="form-col">
                                <div class="form-group">
                                    <label for="visaStatus" data-lang="visaStatus">Current Visa Status</label>
                                    <select id="visaStatus" class="form-control" required>
                                        <option value="">Select visa status</option>
                                        <option value="visit">Visit visa</option>
                                        <option value="cancelled">Cancelled visa</option>
                                        <option value="active">Active visa</option>
                                    </select>
                                </div>
                            </div>
                             <div class="form-col"><div class="form-group"><label for="educationCertificate" data-lang="educationCertificate">Attested Education Certificate</label><select id="educationCertificate" class="form-control" required><option value="">Select option</option><option value="yes">Yes</option><option value="no">No</option></select></div></div>
                        </div>
                        
                        <div id="visaConditionalFields">
                            <div id="visitVisaFields" class="conditional-field hidden"><div class="form-group"><label for="daysLeft" data-lang="daysLeft">How many days left?</label><input type="number" id="daysLeft" class="form-control" placeholder="Enter number of days" min="1"></div></div>
                            <div id="cancelledVisaFields" class="conditional-field hidden">
                                <div class="form-group"><label for="cancelledDate" data-lang="cancelledDate">When was it cancelled?</label><input type="date" id="cancelledDate" class="form-control"></div>
                                <div class="form-group"><label for="cancelledDaysLeft" data-lang="cancelledDaysLeft">How many days are left?</label><input type="number" id="cancelledDaysLeft" class="form-control" placeholder="Calculated automatically" readonly></div>
                            </div>
                            <div id="activeVisaFields" class="conditional-field hidden">
                                <div class="form-group">
                                    <label data-lang="needFor">Need for yourself or someone else?</label>
                                    <div class="radio-option">
                                        <input type="radio" id="forYourself" name="needFor" value="yourself">
                                        <label for="forYourself" data-lang="forYourself">For yourself</label>
                                    </div>
                                    <div class="radio-option">
                                        <input type="radio" id="forSomeoneElse" name="needFor" value="someoneElse">
                                        <label for="forSomeoneElse" data-lang="forSomeoneElse">For someone else</label>
                                    </div>
                                </div>
                                <div id="yourselfFields" class="conditional-field hidden"><div class="form-group"><label for="whenDate" data-lang="when">When?</label><input type="date" id="whenDate" class="form-control"></div></div>
                                <div id="someoneElseFields" class="conditional-field hidden"><div class="form-group"><label for="forWhom" data-lang="forWhom">For whom do you need a visa?</label><input type="text" id="forWhom" class="form-control" placeholder="E.g., wife, brother"></div></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-col"><div class="form-group"><label for="desiredSalary" data-lang="desiredSalary">Desired Salary</label><input type="text" id="desiredSalary" class="form-control" placeholder="e.g., AED 5000"></div></div>
                             <div class="form-col"><div class="form-group"><label for="visitTime" data-lang="visitTime">Time of Visit to Our Office</label><input type="datetime-local" id="visitTime" class="form-control"></div></div>
                        </div>

                        <div id="educationConditionalFields">
                            <div id="educationYesFields" class="conditional-field hidden"><div class="form-group"><label for="position" data-lang="position">What position to mention on ID?</label><input type="text" id="position" class="form-control" placeholder="e.g., Sales Manager"></div></div>
                            <div id="educationNoFields" class="conditional-field hidden"><div class="info-text"><i class="fas fa-info-circle"></i><span data-lang="salesOfficerOnly">Only Sales Officer will be available</span></div></div>
                        </div>
                        
                        <div id="pricingSection" class="conditional-field hidden">
                            <div class="form-row">
                                <div class="form-col">
                                    <div class="form-group">
                                        <label data-lang="companyPrice">Company Price</label>
                                        <p id="companyPriceDisplay" data-lang="selectNationalityLocation">Select nationality and location first</p>
                                    </div>
                                </div>
                                <div class="form-col">
                                    <div class="form-group">
                                        <label for="clientQuotedPrice" data-lang="quotedPrice">Price Quoted to Client (AED)</label>
                                        <input type="number" id="clientQuotedPrice" class="form-control" placeholder="e.g., 7500">
                                    </div>
                                </div>
                            </div>
                             <div id="nigerianVisaInfo" class="info-text hidden"><i class="fas fa-info-circle"></i> <span data-lang="freezoneVisa">This will be a Freezone visa.</span></div>
                             <div id="nigerianNotAvailableInfo" class="info-text hidden"><i class="fas fa-times-circle"></i><span data-lang="nigerianNotAvailable">Service not available for Nigerians outside UAE or with non-cancelled visa.</span></div>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="leadSource" data-lang="leadSource">Lead Source</label>
                                    <select id="leadSource" class="form-control">
                                        <option value="">Select Source</option>
                                        <option value="Website">Website</option>
                                        <option value="Referral">Referral</option>
                                        <option value="Walk-in">Walk-in</option>
                                        <option value="Social Media">Social Media</option>
                                        <option value="Advertisement">Advertisement</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="assignedTo" data-lang="assignedTo">Assigned To</label>
                                    <select id="assignedTo" class="form-control">
                                        <option value="">Select User (Self)</option>
                                        <!-- Users will be populated dynamically here -->
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-col"><div class="form-group"><label for="priority" data-lang="priority">Priority</label><select id="priority" class="form-control"><option value="low" data-lang="low">Low</option><option value="medium" data-lang="medium">Medium</option><option value="high" data-lang="high">High</option></select></div></div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn" id="saveClientBtn"><i class="fas fa-save"></i> <span data-lang="saveClient">Save Client</span></button>
                            <button type="button" class="btn btn-outline" id="clearFormBtn"><i class="fas fa-eraser"></i> <span data-lang="clearForm">Clear Form</span></button>
                            <button type="button" class="btn btn-outline hidden" id="cancelEditBtn"><i class="fas fa-times-circle"></i><span data-lang="cancelEdit">Cancel Edit</span></button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div id="clientData" class="page">
                <div id="adminControls" class="admin-only hidden">
                    <div class="admin-controls-group" style="margin-bottom: 20px;">
                        <label for="searchInput" data-lang="search">Search:</label><input type="text" id="searchInput" class="form-control" placeholder="Name or Phone...">
                        <label for="filterVisaStatus" data-lang="visaStatusFilter">Visa Status:</label><select id="filterVisaStatus" class="form-control"><option value="">All</option><option value="visit">Visit</option><option value="cancelled">Cancelled</option><option value="active">Active</option></select>
                        <label for="filterOverallStatus" data-lang="overallStatusFilter">Overall Status:</label><select id="filterOverallStatus" class="form-control"><option value="">All</option><option value="pending">Pending</option><option value="done">Done</option><option value="not-agreed">Not Agreed</option><option value="not-visited">Not Visited</option></select>
                    </div>
                    <div class="admin-controls-group">
                        <button class="btn btn-sm btn-danger hidden" id="bulkDeleteBtn" style="background-color: var(--danger);"><i class="fas fa-trash-alt"></i><span data-lang="archiveSelected">Archive Selected</span></button>
                        <button class="btn btn-sm btn-outline" id="exportCsvBtn" style="background-color: var(--success); color: white; border: none;"><i class="fas fa-download"></i> <span data-lang="exportCsv">Export to CSV</span></button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="clientsTable" class="responsive-table">
                        <thead>
                            <tr>
                                <th class="admin-only hidden"><input type="checkbox" id="selectAllCheckbox"></th>
                                <th data-lang="clientContact">Client & Contact</th>
                                <th data-lang="details">Details</th>
                                <th data-lang="visaEducation">Visa & Education</th>
                                <th data-lang="pricing">Pricing (AED)</th>
                                <th data-lang="status">Status</th>
                                <th data-lang="priority">Priority</th>
                                <th data-lang="assignedToHeader">Assigned To</th>
                                <th data-lang="lastUpdated">Last Updated</th>
                                <th id="actionsHeader" data-lang="actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div id="archivedData" class="page admin-only hidden">
                 <div class="section-title"><h3 data-lang="archivedLeads">Archived Leads</h3></div>
                 <div id="archivedAdminControls" class="admin-only hidden">
                    <div class="admin-controls-group" style="margin-bottom: 20px;">
                        <label for="archivedSearchInput" data-lang="search">Search:</label><input type="text" id="archivedSearchInput" class="form-control" placeholder="Name or Phone...">
                        <label for="archivedFilterVisaStatus" data-lang="visaStatusFilter">Visa Status:</label><select id="archivedFilterVisaStatus" class="form-control"><option value="">All</option><option value="visit">Visit</option><option value="cancelled">Cancelled</option><option value="active">Active</option></select>
                        <label for="archivedFilterOverallStatus" data-lang="overallStatusFilter">Overall Status:</label><select id="archivedFilterOverallStatus" class="form-control"><option value="">All</option><option value="pending">Pending</option><option value="done">Done</option><option value="not-agreed">Not Agreed</option><option value="not-visited">Not Visited</option></select>
                    </div>
                 </div>
                 <div id="archived-cards-container" class="card-grid"></div>
            </div>

            <div id="settingsPanel" class="page admin-only hidden">
                <div class="section-title"><h3 data-lang="settings">Settings</h3></div>
                
                <!-- Settings sections displayed directly, without a dropdown -->
                <div id="changePasswordSection" class="settings-content-section form-container">
                    <h4 data-lang="changePassword">Change Your Password</h4>
                    <form id="changePasswordForm">
                        <div class="form-group"><label for="currentPassword" data-lang="currentPassword">Current Password</label><input type="password" id="currentPassword" class="form-control" placeholder="Enter your current password" required></div>
                        <div class="form-group"><label for="newPassword" data-lang="newPassword">New Password</label><input type="password" id="newPassword" class="form-control" placeholder="Enter a new password" required></div>
                        <div class="form-group"><label for="confirmPassword" data-lang="confirmNewPassword">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control" placeholder="Confirm the new password" required></div>
                        <button type="submit" class="btn" id="updatePasswordBtn"><span data-lang="updatePassword">Update Password</span></button>
                    </form>
                </div>

                <div id="createUserSection" class="settings-content-section form-container main-admin-only hidden">
                    <h4 data-lang="createUser">Create New User</h4>
                    <form id="createUserForm">
                         <div class="form-row">
                            <div class="form-col">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="newUserEmail" data-lang="newUserEmail">New User's Email</label>
                                    <input type="email" id="newUserEmail" class="form-control" placeholder="Enter email" required>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group" style="margin-bottom: 0;">
                                    <label for="newUserPassword" data-lang="newUserPassword">Password</label>
                                    <input type="password" id="newUserPassword" class="form-control" placeholder="Enter password" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group"><label for="newUserRole" data-lang="assignRole">Assign Role</label>
                            <select id="newUserRole" class="form-control">
                                <option value="user">User</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <button type="submit" class="btn" id="createUserBtn"><span data-lang="createUserBtn">Create User</span></button>
                    </form>
                </div>
                
                <div id="userManagementSection" class="settings-content-section form-container main-admin-only hidden">
                    <h4 data-lang="userManagement">User Management</h4>
                    <div class="table-container">
                        <table class="responsive-table">
                            <thead>
                                <tr>
                                    <th data-lang="userEmailHeader">User Email</th>
                                    <th data-lang="currentRole">Current Role</th>
                                    <th data-lang="lastLogin">Last Login</th>
                                    <th data-lang="actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementTableBody">
                                <!-- User rows will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- New User Performance Overview Section -->
                <div id="userPerformanceOverviewSection" class="settings-content-section form-container main-admin-only hidden">
                    <h4 data-lang="userPerformanceOverview">User Performance Overview</h4>
                    <div class="table-container">
                        <table class="responsive-table">
                            <thead>
                                <tr>
                                    <th data-lang="userEmailHeader">User Email</th>
                                    <th data-lang="totalLeadsAdded">Total Leads Added</th>
                                    <th data-lang="leadsDone">Leads Done</th>
                                    <th data-lang="conversionRate">Conversion Rate</th>
                                </tr>
                            </thead>
                            <tbody id="userPerformanceTableBody">
                                <!-- User performance data will be injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="companyPriceManagementSection" class="settings-content-section form-container main-admin-only hidden">
                    <h4 data-lang="companyPriceManagement">Company Price Management</h4>
                    <form id="companyPriceForm">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="priceIndiaInside" data-lang="priceIndiaInside">India (Inside UAE)</label>
                                    <input type="number" id="priceIndiaInside" class="form-control" placeholder="e.g., 7999" required min="0">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="priceIndiaOutside" data-lang="priceIndiaOutside">India (Outside UAE)</label>
                                    <input type="number" id="priceIndiaOutside" class="form-control" placeholder="e.g., 6999" required min="0">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="pricePakistanInside" data-lang="pricePakistanInside">Pakistan (Inside UAE)</label>
                                    <input type="number" id="pricePakistanInside" class="form-control" placeholder="e.g., 7999" required min="0">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="pricePakistanOutside" data-lang="pricePakistanOutside">Pakistan (Outside UAE)</label>
                                    <input type="number" id="pricePakistanOutside" class="form-control" placeholder="e.g., 12000" required min="0">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="priceNigerianCancelled" data-lang="priceNigerianCancelled">Nigerian (Cancelled Visa Inside UAE)</label>
                                    <input type="number" id="priceNigerianCancelled" class="form-control" placeholder="e.g., 7500" required min="0">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="priceOtherInside" data-lang="priceOtherInside">Other (Inside UAE)</label>
                                    <input type="number" id="priceOtherInside" class="form-control" placeholder="e.g., 6499" required min="0">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="priceOtherOutside" data-lang="priceOtherOutside">Other (Outside UAE)</label>
                                    <input type="number" id="priceOtherOutside" class="form-control" placeholder="e.g., 5499" required min="0">
                                    </div>
                                </div>
                                <div class="form-col"></div>
                            </div>
                            <button type="submit" class="btn" id="savePricesBtn"><span data-lang="savePrices">Save Prices</span></button>
                        </form>
                    </div>

                    <div id="globalAnnouncementsSection" class="settings-content-section form-container main-admin-only hidden">
                        <h4 data-lang="globalAnnouncements">Global Announcements</h4>
                        <form id="globalAnnouncementForm">
                            <div class="form-group">
                                <label for="announcementMessageInput" data-lang="announcementMessage">Announcement Message</label>
                                <textarea id="announcementMessageInput" class="form-control" rows="5" placeholder="Enter global announcement message"></textarea>
                            </div>
                            <button type="submit" class="btn" id="saveAnnouncementBtn"><span data-lang="publishAnnouncement">Publish Announcement</span></button>
                            <button type="button" class="btn btn-outline" id="clearAnnouncementBtn"><i class="fas fa-trash"></i> <span data-lang="clearAnnouncement">Clear Announcement</span></button>
                        </form>
                        <div id="currentAnnouncementDisplay" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--light-gray);">
                            <h5 data-lang="currentAnnouncement">Current Global Announcement:</h5>
                            <p id="currentAnnouncementText" style="color: var(--gray); font-style: italic;">No current announcement.</p>
                            <small id="announcementLastUpdated" style="color: var(--light-gray);"></small>
                        </div>
                    </div>

                    <!-- New Auto Archive Settings Section -->
                    <div id="autoArchiveSettingsSection" class="settings-content-section form-container main-admin-only hidden">
                        <h4 data-lang="autoArchiveSettings">Auto Archive Inactive Leads</h4>
                        <p data-lang="autoArchiveInfo">This tool will archive leads that have not been updated for a specified number of days.</p>
                        <div class="form-group">
                            <label for="autoArchiveThresholdDays" data-lang="archiveThresholdDays">Archive leads older than (days):</label>
                            <input type="number" id="autoArchiveThresholdDays" class="form-control" value="90" min="1" required>
                        </div>
                        <button type="button" class="btn" id="runAutoArchiveBtn"><i class="fas fa-history"></i> <span data-lang="runAutoArchive">Run Auto-Archive Now</span></button>
                    </div>

                </div>
            </div>
        </main>
    </div>
    
    <!-- Toast & Modal -->
    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage"></span></div>
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmationTitle">Are you sure?</h3>
            <p id="confirmationMessage">This action cannot be undone.</p>
            <div class="modal-actions">
                <button id="confirmBtn" class="btn">Confirm</button>
                <button id="cancelBtn" class="btn btn-outline">Cancel</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Message Generation Modal -->
    <div id="whatsappModal" class="modal-overlay">
        <div class="modal-content llm-modal-content">
            <h3 id="whatsappModalTitle">WhatsApp Message Draft</h3>
            <textarea id="generatedWhatsAppContent" readonly></textarea>
            <div class="modal-actions">
                <button id="copyWhatsAppBtn" class="btn"><i class="fas fa-copy"></i> Copy to Clipboard</button>
                <button id="closeWhatsAppModalBtn" class="btn btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Lead Insight Modal -->
    <div id="leadInsightModal" class="modal-overlay">
        <div class="modal-content llm-modal-content">
            <h3 id="leadInsightModalTitle">Lead Insight ✨</h3>
            <textarea id="generatedLeadInsightContent" readonly></textarea>
            <div class="modal-actions">
                <button id="copyLeadInsightBtn" class="btn"><i class="fas fa-copy"></i> Copy to Clipboard</button>
                <button id="closeLeadInsightModalBtn" class="btn btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal-overlay">
        <div class="modal-content notes-modal-content">
            <h3 id="notesModalTitle">Client Notes for <span id="notesClientName"></span></h3>
            <div id="notesList" class="notes-list">
                <!-- Notes will be loaded here -->
            </div>
            <div id="addNoteSection" class="form-group admin-only hidden">
                <label for="newNoteInput">Add New Note:</label>
                <textarea id="newNoteInput" class="form-control" rows="3" placeholder="Type your note here..."></textarea>
                <button id="addNoteBtn" class="btn btn-sm"><i class="fas fa-plus"></i> Add Note</button>
            </div>
            <div class="modal-actions">
                <button id="closeNotesModalBtn" class="btn btn-outline">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to encapsulate the script
        // This helps in keeping variables and functions out of the global scope.
        (function() {
            // Firebase configuration
            // NOTE: The API key is exposed in client-side code. For production, consider environment variables or server-side solutions.
            const firebaseConfig = {
                apiKey: "AIzaSyCkYC7NABGEjL2ymZ4wNFjYmaqKO8slc30",
                authDomain: "lead-management-6f631.firebaseapp.com",
                databaseURL: "https://lead-management-6f631-default-rtdb.firebaseio.com",
                projectId: "lead-management-6f631",
                storageBucket: "lead-management-6f631.appspot.com",
                messagingSenderId: "152258620675",
                appId: "1:152258620675:web:3c55e51eab973d88bf0d36"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const database = firebase.database();
            
            // Database Paths
            const leadsRefPath = 'leads/shared_leads';
            const usersRefPath = 'users';
            const settingsRefPath = 'settings'; // New Firebase path for general settings
            const MAIN_ADMIN_EMAIL = "zsarwar613@gmail.com";
            const CANCELLED_VISA_GRACE_PERIOD_DAYS = 28; // Define grace period
            const AUTO_ARCHIVE_DEFAULT_THRESHOLD_DAYS = 90; // Default days for auto-archive

            // Gemini API configuration
            // The API key is left empty as the Canvas environment will inject it at runtime.
            const GEMINI_API_KEY = ""; 
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
            
            let allClientsData = [];
            let archivedClientsData = [];
            let allUsersData = []; // To store all user data for lead assignment and performance tracking
            let dataListenerAttached = false;
            let companyPrices = {}; // Stores dynamically loaded company prices

            // DOM Element variables
            let loginScreen, appContainer, loginForm, sidebarLinks, pages, pageTitle, clientForm, clearFormBtn, cancelEditBtn, clientsTableBody, archivedCardsContainer, toast, toastMessage, userAvatar, userName, userEmail, saveClientBtn, adminControls, bulkDeleteBtn, actionsHeader, formTitle, searchInput, filterVisaStatus, filterOverallStatus, changePasswordForm, visaStatusSelect, educationCertificate, nationalitySelect, locationSelect, userProfileContainer, profilePopover, adminSettingsBtn, logoutBtn, languageToggle, languageOptions, selectedLanguageText, createUserForm, whatsappModal, generatedWhatsAppContent, copyWhatsAppBtn, closeWhatsAppModalBtn, changePasswordSection, createUserSection, userManagementSection, companyPriceManagementSection, globalAnnouncementsSection, companyPriceForm, savePricesBtn, announcementBanner, announcementMessage, globalAnnouncementForm, announcementMessageInput, saveAnnouncementBtn, clearAnnouncementBtn, currentAnnouncementDisplay, currentAnnouncementText, announcementLastUpdated, cancelledDateInput, cancelledDaysLeftInput, leadInsightModal, generatedLeadInsightContent, copyLeadInsightBtn, closeLeadInsightModalBtn, notesModal, notesModalTitle, notesClientName, notesList, newNoteInput, addNoteBtn, closeNotesModalBtn, assignedToSelect, leadSourceSelect, exportCsvBtn, archivedSearchInput, archivedFilterVisaStatus, archivedFilterOverallStatus, archivedAdminControls, userPerformanceOverviewSection, userPerformanceTableBody, userLeadsAdded, userLeadsDone, userConversionRate, autoArchiveSettingsSection, autoArchiveThresholdDaysInput, runAutoArchiveBtn;

            
            // State
            let currentUser = null, currentUserRole = 'user';
            let currentEditingClientId = null;
            let visaStatusChart = null, overallStatusChart = null, leadSourceChart = null; // New chart
            const chartColors = ['#06d6a0', '#ef476f', '#4361ee', '#ffd166', '#6c757d', '#7209b7', '#f48c06', '#a9d6e5'];


            // --- NAVIGATION HELPER ---
            function navigateToPage(pageId) {
                const linkToActivate = document.querySelector(`.sidebar-link[data-page="${pageId}"]`);
                if (linkToActivate) {
                    const textElement = linkToActivate.querySelector('i').nextSibling;
                    if(textElement) pageTitle.textContent = textElement.textContent.trim();
                }

                sidebarLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.page === pageId);
                });
                pages.forEach(page => {
                    page.classList.toggle('active', page.id === pageId);
                });

                if (pageId === 'clientData') {
                    applyFilters();
                    // Show/hide export button based on admin status
                    if (exportCsvBtn) exportCsvBtn.classList.toggle('hidden', !(currentUserRole === 'admin' || currentUserRole === 'main-admin' || currentUserRole === 'manager'));
                }
                if (pageId === 'archivedData') applyArchivedFilters(); // New filter for archived data
                if (pageId === 'dashboard') loadDashboardData();
                if (pageId === 'settingsPanel') {
                    // Load all settings data directly as sections are always present
                    loadUserManagement();
                    loadCompanyPrices();
                    loadGlobalAnnouncement();
                    loadUserPerformanceOverview(); // New admin feature
                    loadAutoArchiveSettings(); // New admin feature
                }
            }

            // --- UTILITY FUNCTIONS ---
            function showToast(message, isSuccess = true) {
                toastMessage.textContent = message;
                toast.className = `toast ${isSuccess ? "toast-success" : "toast-error"} show`;
                const icon = toast.querySelector('i');
                icon.className = `fas ${isSuccess ? 'fa-check-circle' : 'fa-times-circle'}`;
                setTimeout(() => toast.classList.remove('show'), 3000);
            }
            
            function showConfirmation(title, message, onConfirm) {
                const modal = document.getElementById('confirmationModal');
                modal.querySelector('#confirmationTitle').textContent = title;
                modal.querySelector('#confirmationMessage').textContent = message;
                modal.style.display = 'flex';

                const confirmBtn = modal.querySelector('#confirmBtn');
                const cancelBtn = modal.querySelector('#cancelBtn');
                
                // Clear previous event listeners to prevent multiple calls
                confirmBtn.onclick = null; 
                cancelBtn.onclick = null;

                const close = () => {
                    modal.style.display = 'none';
                };
                
                confirmBtn.onclick = () => { onConfirm(); close(); };
                cancelBtn.onclick = close;
            }

            function showWhatsAppModal(messageContent) {
                generatedWhatsAppContent.value = messageContent;
                whatsappModal.style.display = 'flex';
            }

            function hideWhatsAppModal() {
                whatsappModal.style.display = 'none';
                generatedWhatsAppContent.value = ''; // Clear content on close
            }

            function showLeadInsightModal(insightContent) {
                generatedLeadInsightContent.value = insightContent;
                leadInsightModal.style.display = 'flex';
            }

            function hideLeadInsightModal() {
                leadInsightModal.style.display = 'none';
                generatedLeadInsightContent.value = ''; // Clear content on close
            }

            function showNotesModal(clientId) {
                const client = allClientsData.find(c => c.id === clientId) || archivedClientsData.find(c => c.id === clientId);
                if (!client) {
                    showToast("Client not found for notes.", false);
                    return;
                }
                notesClientName.textContent = client.name || 'N/A';
                currentNotesClientId = clientId; // Set global current client for adding notes

                renderNotes(client.notes || []);

                const isManager = currentUserRole === 'manager' || currentUserRole === 'admin' || currentUserRole === 'main-admin';
                if (addNoteSection) addNoteSection.classList.toggle('hidden', !isManager); // Show add note field for admins/managers

                notesModal.style.display = 'flex';
            }

            function hideNotesModal() {
                notesModal.style.display = 'none';
                notesList.innerHTML = ''; // Clear notes list
                newNoteInput.value = ''; // Clear new note input
                currentNotesClientId = null;
            }

            let currentNotesClientId = null; // To keep track of which client's notes are open

            function renderNotes(notes) {
                notesList.innerHTML = '';
                if (notes.length === 0) {
                    notesList.innerHTML = '<p style="text-align: center; color: var(--gray);">No notes for this client yet.</p>';
                    return;
                }
                // Sort notes by timestamp descending (newest first)
                notes.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(note => {
                    const noteItem = document.createElement('div');
                    noteItem.className = 'note-item';
                    noteItem.innerHTML = `
                        <p>${note.text}</p>
                        <small>Added by: ${note.addedBy} on ${formatTimestamp(note.timestamp)}</small>
                    `;
                    notesList.appendChild(noteItem);
                });
            }

            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showToast('Copied to clipboard!', true);
                } catch (err) {
                    showToast('Failed to copy text.', false);
                    console.error('Failed to copy text:', err);
                }
                document.body.removeChild(textarea);
            }

            function formatTimestamp(isoString) {
                if (!isoString) return 'N/A';
                const date = new Date(isoString);
                return date.toLocaleString(); // Formats to local date and time
            }

            // Function to calculate remaining days for cancelled visa
            function calculateRemainingCancelledDays(cancelledDateString) {
                if (!cancelledDateString) {
                    return null; // No date, no calculation
                }
                const cancelledDate = new Date(cancelledDateString);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date to midnight for consistent day calculation

                const diffTime = today.getTime() - cancelledDate.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Calculate full days passed

                const remainingDays = CANCELLED_VISA_GRACE_PERIOD_DAYS - diffDays;
                return Math.max(0, remainingDays); // Ensure it doesn't go below zero
            }
            
            // --- AUTH & UI SETUP ---
            async function initApp() {
                auth.onAuthStateChanged(async user => {
                    if (user) {
                         // *** NEW: Verify user exists in the database before proceeding ***
                        const userRef = database.ref(`${usersRefPath}/${user.uid}`);
                        const snapshot = await userRef.once('value');

                        if (!snapshot.exists() && user.email !== MAIN_ADMIN_EMAIL) {
                            // If user is not in the database (was deleted), sign them out.
                            showToast("Your account access has been revoked.", false);
                            auth.signOut();
                            return;
                        }
                        // *** END NEW ***
                        
                        currentUser = user;
                        // Update last login timestamp for the current user
                        database.ref(`${usersRefPath}/${user.uid}/lastLoginAt`).set(new Date().toISOString());

                        await setupUserRole(user);
                        await fetchAllUsers(); // Fetch all users when app initializes
                        setupUIForUser();
                        attachDataListener(); 
                        navigateToPage('dashboard');
                        await checkAndDisplayAssignedLeadAnnouncements(); // NEW: Check for assignment announcements
                    } else {
                        currentUser = null;
                        currentUserRole = 'user';
                        allUsersData = []; // Clear users data on logout
                        setupUIForGuest();
                        if (dataListenerAttached) {
                            database.ref(leadsRefPath).off();
                            database.ref(`${settingsRefPath}/globalMessage`).off(); // Detach global message listener
                            dataListenerAttached = false;
                        }
                    }
                });
            }
            
            async function setupUserRole(user) {
                if (user.email === MAIN_ADMIN_EMAIL) {
                    currentUserRole = 'main-admin';
                    return;
                }
                const userRef = database.ref(`${usersRefPath}/${user.uid}`);
                const snapshot = await userRef.once('value');
                if (snapshot.exists()) {
                    currentUserRole = snapshot.val().role || 'user';
                } else {
                    currentUserRole = 'user';
                    // This part should theoretically not be reached for non-main-admins due to the check in initApp
                    // However, if a user is created via Firebase Auth console directly, this handles initial role assignment.
                    userRef.set({
                        email: user.email,
                        role: currentUserRole,
                        createdAt: new Date().toISOString(),
                        lastLoginAt: new Date().toISOString() // Initial last login
                    });
                }
            }

            async function fetchAllUsers() {
                const usersSnapshot = await database.ref(usersRefPath).once('value');
                allUsersData = [];
                if (usersSnapshot.exists()) {
                    usersSnapshot.forEach(childSnap => {
                        const userData = childSnap.val();
                        allUsersData.push({ uid: childSnap.key, email: userData.email, role: userData.role });
                    });
                }
                populateAssignedToDropdown(); // Populate dropdown after fetching users
            }

            function populateAssignedToDropdown() {
                if (!assignedToSelect) return;
                assignedToSelect.innerHTML = '<option value="">Select User (Self)</option>'; // Default option
                allUsersData.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.email;
                    option.textContent = user.email;
                    assignedToSelect.appendChild(option);
                });
            }


            function capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            function setupUIForUser() {
                loginScreen.style.display = 'none';
                appContainer.classList.remove('hidden');
                
                let displayName;
                if(currentUser.email === MAIN_ADMIN_EMAIL) {
                    displayName = "Planner Zohaib";
                } else {
                    const emailPrefix = currentUser.email.split('@')[0];
                    displayName = capitalizeFirstLetter(emailPrefix);
                }
                
                userAvatar.textContent = displayName.charAt(0).toUpperCase();
                userName.textContent = displayName;
                userEmail.textContent = currentUser.email;

                const isManager = currentUserRole === 'manager' || currentUserRole === 'admin' || currentUserRole === 'main-admin';
                const isAdmin = currentUserRole === 'admin' || currentUserRole === 'main-admin';
                const isMainAdmin = currentUserRole === 'main-admin';
                
                document.querySelectorAll('.admin-only').forEach(el => el.classList.toggle('hidden', !isAdmin));
                document.querySelectorAll('.manager-only').forEach(el => el.classList.toggle('hidden', !isManager));
                document.querySelectorAll('.main-admin-only').forEach(el => {
                    if (!el.closest('.settings-content-section') && !el.closest('#archivedAdminControls')) { // Exclude settings sections handled below
                        el.classList.toggle('hidden', !isMainAdmin);
                    }
                });

                // Control visibility of specific settings sections based on main-admin role
                if (createUserSection) createUserSection.classList.toggle('hidden', !isMainAdmin);
                if (userManagementSection) userManagementSection.classList.toggle('hidden', !isMainAdmin);
                if (companyPriceManagementSection) companyPriceManagementSection.classList.toggle('hidden', !isMainAdmin);
                if (globalAnnouncementsSection) globalAnnouncementsSection.classList.toggle('hidden', !isMainAdmin);
                if (userPerformanceOverviewSection) userPerformanceOverviewSection.classList.toggle('hidden', !isMainAdmin);
                if (autoArchiveSettingsSection) autoArchiveSettingsSection.classList.toggle('hidden', !isMainAdmin);
                
                // Archived controls visibility
                if (archivedAdminControls) archivedAdminControls.classList.toggle('hidden', !isMainAdmin);


                if(actionsHeader) actionsHeader.classList.toggle('hidden', !isAdmin);
                
                if(adminControls) {
                    adminControls.classList.toggle('hidden', !isManager);
                }

                // Re-enabling developer tool disabling for non-main-admins
                if (!isMainAdmin) {
                    document.addEventListener('contextmenu', event => event.preventDefault());
                    document.addEventListener('keydown', event => {
                        // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
                        if (event.keyCode === 123 || (event.ctrlKey && event.shiftKey && (event.key === 'I' || event.key === 'i' || event.key === 'J' || event.key === 'j' || event.key === 'C' || event.key === 'c'))) {
                            event.preventDefault();
                        }
                    });
                }
            }
            
            function setupUIForGuest() {
                loginScreen.style.display = 'flex';
                appContainer.classList.add('hidden');
                const submitBtn = loginForm.querySelector('button[type="submit"]');
                if(submitBtn) {
                    submitBtn.innerHTML = 'Sign In';
                    submitBtn.disabled = false;
                }
            }
            
            // --- EVENT LISTENERS ---
            function initEventListeners() {
                loginForm.addEventListener('submit', handleLogin);
                
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        navigateToPage(this.dataset.page);
                    });
                });
                
                clientForm.addEventListener('submit', handleClientFormSubmit);
                clearFormBtn.addEventListener('click', resetForm);
                cancelEditBtn.addEventListener('click', resetForm);
                
                visaStatusSelect.addEventListener('change', handleVisaStatusChange);
                educationCertificate.addEventListener('change', handleEducationCertificateChange);
                document.getElementById('forYourself')?.addEventListener('change', handleActiveVisaChange);
                document.getElementById('forSomeoneElse')?.addEventListener('change', handleActiveVisaChange);

                // Add event listener for cancelledDate input to auto-calculate days left
                if (cancelledDateInput) { // Added null check for safety
                    cancelledDateInput.addEventListener('input', updateCancelledDaysLeftDisplay);
                }

                [nationalitySelect, locationSelect, visaStatusSelect].forEach(el => {
                    el.addEventListener('change', updateCompanyPrice);
                });
                
                if(changePasswordForm) {
                    changePasswordForm.addEventListener('submit', handleChangePassword);
                }
                if(createUserForm) {
                    createUserForm.addEventListener('submit', handleCreateUser);
                }
                if(searchInput) {
                     [searchInput, filterVisaStatus, filterOverallStatus].forEach(el => el.addEventListener('input', applyFilters));
                }
                
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.addEventListener('change', handleSelectAll);
                }
                if (bulkDeleteBtn) {
                    bulkDeleteBtn.addEventListener('click', handleBulkArchive);
                }
                if (exportCsvBtn) { // New Export CSV button listener
                    exportCsvBtn.addEventListener('click', exportClientsToCsv);
                }

                // New Archived Filters
                if (archivedSearchInput) {
                    [archivedSearchInput, archivedFilterVisaStatus, archivedFilterOverallStatus].forEach(el => el.addEventListener('input', applyArchivedFilters));
                }

                // New Auto-Archive button
                if (runAutoArchiveBtn) {
                    runAutoArchiveBtn.addEventListener('click', runAutoArchive);
                }
                
                // --- POPOVER AND DROPDOWN LISTENERS ---
                languageToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    languageOptions.classList.toggle('show');
                    languageToggle.classList.toggle('open');
                });
                
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const langValue = e.currentTarget.dataset.langValue;
                        setLanguage(langValue);
                        languageOptions.classList.remove('show');
                        languageToggle.classList.remove('open');
                    });
                });

                userProfileContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profilePopover.classList.toggle('show');
                });

                adminSettingsBtn.addEventListener('click', () => {
                    navigateToPage('settingsPanel');
                    profilePopover.classList.remove('show');
                });

                logoutBtn.addEventListener('click', () => {
                    auth.signOut();
                    showToast("You have been logged out.", true);
                    profilePopover.classList.remove('show');
                });

                document.addEventListener('click', (event) => {
                    if (!profilePopover.contains(event.target) && !userProfileContainer.contains(event.target)) {
                        profilePopover.classList.remove('show');
                    }
                    if (!languageOptions.contains(event.target) && !languageToggle.contains(event.target)) {
                        languageOptions.classList.remove('show');
                        languageToggle.classList.remove('open');
                    }
                });

                // --- Event Delegation for Client Table Actions ---
                clientsTableBody.addEventListener('click', handleClientTableClick);
                clientsTableBody.addEventListener('change', handleClientTableChange);

                // --- WhatsApp Modal Listeners ---
                copyWhatsAppBtn.addEventListener('click', () => {
                    copyToClipboard(generatedWhatsAppContent.value);
                });
                closeWhatsAppModalBtn.addEventListener('click', hideWhatsAppModal);

                // --- Lead Insight Modal Listeners ---
                copyLeadInsightBtn.addEventListener('click', () => {
                    copyToClipboard(generatedLeadInsightContent.value);
                });
                closeLeadInsightModalBtn.addEventListener('click', hideLeadInsightModal);

                // --- Notes Modal Listeners ---
                if (addNoteBtn) {
                    addNoteBtn.addEventListener('click', addClientNote);
                }
                if (closeNotesModalBtn) {
                    closeNotesModalBtn.addEventListener('click', hideNotesModal);
                }
                // Event delegation for notes icon in table is handled by handleClientTableClick

                // --- Company Price Form Listeners ---
                if (companyPriceForm) {
                    companyPriceForm.addEventListener('submit', handleSaveCompanyPrices);
                }

                // --- Global Announcement Form Listeners ---
                if (globalAnnouncementForm) {
                    globalAnnouncementForm.addEventListener('submit', handleSaveGlobalAnnouncement);
                    clearAnnouncementBtn.addEventListener('click', handleClearGlobalAnnouncement);
                }
            }

            // Updates the "Days Left" input field for cancelled visas
            function updateCancelledDaysLeftDisplay() {
                const cancelledDateString = cancelledDateInput.value;
                const remainingDays = calculateRemainingCancelledDays(cancelledDateString);
                if (remainingDays !== null) {
                    cancelledDaysLeftInput.value = remainingDays;
                } else {
                    cancelledDaysLeftInput.value = ''; // Clear if no date
                }
            }


            // Handles clicks on buttons within the clients table (edit, archive, delete, restore, generate WhatsApp message)
            function handleClientTableClick(event) {
                const target = event.target;
                const row = target.closest('tr[data-id]'); // Find the closest table row with a data-id
                const archivedCard = target.closest('.info-card[data-id]'); // Find the closest archived card with a data-id

                let clientId;
                if (row) {
                    clientId = row.dataset.id;
                } else if (archivedCard) {
                    clientId = archivedCard.dataset.id;
                } else {
                    return; // Not an action element within a client/archived item
                }
                
                const actionButton = target.closest('.action-btn');
                if (!actionButton) return; // Not an action button

                const action = actionButton.dataset.action;
                
                switch (action) {
                    case 'edit':
                        editClient(clientId);
                        break;
                    case 'archive':
                        const clientNameArchive = row.querySelector('strong').textContent;
                        archiveClient(clientId, clientNameArchive);
                        break;
                    case 'restore':
                        const clientNameRestore = archivedCard.querySelector('h4').textContent; // For archived cards
                        restoreClient(clientId, clientNameRestore);
                        break;
                    case 'delete':
                        const clientNameDelete = archivedCard.querySelector('h4').textContent; // For archived cards
                        deleteClient(clientId, clientNameDelete);
                        break;
                    case 'whatsapp-link': // This is for the direct WhatsApp link, not the generate button
                        event.preventDefault(); // Prevent default link behavior
                        openWhatsApp(clientId);
                        break;
                    case 'generate-whatsapp':
                        generateWhatsAppMessage(clientId);
                        break;
                    case 'generate-insight': // New case for lead insight
                        generateLeadInsight(clientId);
                        break;
                    case 'view-notes': // New case for view notes
                        showNotesModal(clientId);
                        break;
                }
            }

            // Handles changes on select elements within the clients table (status update)
            function handleClientTableChange(event) {
                const target = event.target;
                if (target.classList.contains('status-select')) {
                    const row = target.closest('tr[data-id]');
                    if (!row) return;
                    const clientId = row.dataset.id;
                    const newStatus = target.value;
                    const clientName = row.querySelector('strong').textContent;
                    updateStatus(clientId, newStatus, clientName);
                }
            }

            // --- AUTH HANDLERS ---
            function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
                submitBtn.disabled = true;
                
                auth.signInWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        showToast(`Welcome back!`, true);
                    })
                    .catch(error => {
                        showToast("Login failed: " + error.message, false);
                    }).finally(() => {
                        submitBtn.innerHTML = 'Sign In';
                        submitBtn.disabled = false;
                    });
            }
            
            function handleChangePassword(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const updateBtn = document.getElementById('updatePasswordBtn');

                if (newPassword !== confirmPassword) {
                    showToast("New passwords do not match.", false);
                    return;
                }
                if (newPassword.length < 6) {
                    showToast("Password should be at least 6 characters long.", false);
                    return;
                }

                updateBtn.disabled = true;
                updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';

                const user = auth.currentUser;
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

                user.reauthenticateWithCredential(credential).then(() => {
                    return user.updatePassword(newPassword);
                }).then(() => {
                    showToast("Password updated successfully!", true);
                    changePasswordForm.reset();
                }).catch((error) => {
                    showToast(`Error: ${error.message}`, false);
                }).finally(() => {
                    updateBtn.disabled = false;
                    updateBtn.querySelector('span').textContent = 'Update Password';
                });
            }
            
            async function handleCreateUser(e) {
                e.preventDefault();
                const email = document.getElementById('newUserEmail').value;
                const password = document.getElementById('newUserPassword').value;
                const role = document.getElementById('newUserRole').value;
                const createBtn = document.getElementById('createUserBtn');

                createBtn.disabled = true;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';

                let secondaryApp;
                try {
                    // Initialize a secondary app to create user without signing out the admin
                    secondaryApp = firebase.initializeApp(firebaseConfig, `secondary-auth-create-${Date.now()}`);
                    const secondaryAuth = secondaryApp.auth();

                    const userCredential = await secondaryAuth.createUserWithEmailAndPassword(email, password);
                    const newUser = userCredential.user;

                    // Set role in the database
                    await database.ref(`${usersRefPath}/${newUser.uid}`).set({
                        email: email,
                        role: role,
                        createdAt: new Date().toISOString(),
                        lastLoginAt: new Date().toISOString() // Set initial last login
                    });

                    showToast('User created successfully!', true);
                    createUserForm.reset();
                    loadUserManagement(); // Refresh the user list
                    fetchAllUsers(); // Refresh the list of users for assignment dropdown

                } catch (error) {
                    showToast(`Error creating user: ${error.message}`, false);
                } finally {
                    createBtn.disabled = false;
                    const span = createBtn.querySelector('span');
                    if (span) {
                        span.textContent = 'Create User';
                    } else {
                        createBtn.textContent = 'Create User';
                    }
                    if (secondaryApp) {
                        // Ensure secondary app is deleted to clean up resources
                        await secondaryApp.auth().signOut();
                        await secondaryApp.delete();
                    }
                }
            }
            
            function handleVisaStatusChange() {
                const status = visaStatusSelect.value;
                document.querySelectorAll('#visaConditionalFields > .conditional-field').forEach(el => el.classList.add('hidden'));
                
                if (status === 'visit') {
                    document.getElementById('visitVisaFields').classList.remove('hidden');
                } else if (status === 'cancelled') {
                    document.getElementById('cancelledVisaFields').classList.remove('hidden');
                    updateCancelledDaysLeftDisplay(); // Calculate when cancelled is selected
                } else if (status === 'active') {
                    document.getElementById('activeVisaFields').classList.remove('hidden');
                    handleActiveVisaChange();
                }
                updateCompanyPrice(); 
            }
            
            function handleActiveVisaChange() {
                const forYourselfChecked = document.getElementById('forYourself')?.checked;
                document.getElementById('yourselfFields').classList.toggle('hidden', !forYourselfChecked);
                document.getElementById('someoneElseFields').classList.toggle('hidden', forYourselfChecked);
            }
            
            function handleEducationCertificateChange() {
                const status = educationCertificate.value;
                document.getElementById('educationYesFields').classList.toggle('hidden', status !== 'yes');
                document.getElementById('educationNoFields').classList.toggle('hidden', status !== 'no');
            }

            // --- DATA HANDLING ---
            function attachDataListener() {
                if (dataListenerAttached) return; 
                
                const leadsRef = database.ref(leadsRefPath);
                const globalMessageRef = database.ref(`${settingsRefPath}/globalMessage`);

                leadsRef.on('value', snapshot => {
                    let clients = [];
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            clients.push({ id: child.key, ...child.val() });
                        });
                    }

                    const isPrivileged = currentUserRole === 'admin' || currentUserRole === 'main-admin' || currentUserRole === 'manager';
                    if (isPrivileged) {
                        allClientsData = clients.filter(c => !c.isArchived).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    } else {
                        // Regular users only see leads they added or are assigned to them
                        allClientsData = clients.filter(c => !c.isArchived && (c.addedBy === currentUser.email || c.assignedToUserEmail === currentUser.email)).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    }
                    
                    archivedClientsData = clients.filter(c => c.isArchived).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    applyFilters(); // Re-render client data
                    applyArchivedFilters(); // Re-render archived data
                    loadDashboardData(); // Update dashboard charts
                    loadUserPerformanceOverview(); // Update performance stats
                }, error => {
                    console.error("Firebase Leads Read Error: ", error);
                    showToast("Error loading real-time client data: " + error.message, false);
                });

                globalMessageRef.on('value', snapshot => {
                    const messageData = snapshot.val();
                    if (messageData && messageData.message) {
                        announcementMessage.textContent = messageData.message;
                        announcementLastUpdated.textContent = `Last updated: ${formatTimestamp(messageData.timestamp)} by ${messageData.updatedBy}`;
                        announcementBanner.classList.remove('hidden');
                    } else {
                        announcementBanner.classList.add('hidden');
                        announcementMessage.textContent = '';
                        announcementLastUpdated.textContent = '';
                    }
                }, error => {
                    console.error("Firebase Global Message Read Error: ", error);
                    showToast("Error loading global announcement: " + error.message, false);
                });

                dataListenerAttached = true;
            }
            
            function handleClientFormSubmit(e) {
                e.preventDefault();
                saveClientBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveClientBtn.disabled = true;

                try {
                    if (!currentUser) {
                        showToast("You must be logged in to save a client.", false);
                        throw new Error("User not authenticated");
                    }
                    
                    const existingClient = currentEditingClientId ? [...allClientsData, ...archivedClientsData].find(c => c.id === currentEditingClientId) || {} : {};

                    const getNumericValue = (id) => {
                        const value = document.getElementById(id).value;
                        return value ? parseFloat(value) : null;
                    };

                    const newAssignedToUserEmail = assignedToSelect.value || currentUser.email; // Get new assigned user

                    const formData = {
                        name: document.getElementById('clientName').value.trim(),
                        phone: document.getElementById('phone').value.trim(),
                        nationality: document.getElementById('nationality').value,
                        location: document.getElementById('location').value,
                        visaStatus: visaStatusSelect.value,
                        educationCert: document.getElementById('educationCertificate').value,
                        salary: document.getElementById('desiredSalary').value.trim(),
                        visitTime: document.getElementById('visitTime').value,
                        priority: document.getElementById('priority').value,
                        companyPrice: document.getElementById('companyPriceDisplay').textContent,
                        clientQuotedPrice: getNumericValue('clientQuotedPrice'),
                        leadSource: leadSourceSelect.value, // New field
                        assignedToUserEmail: newAssignedToUserEmail, // New field
                        status: existingClient.status || "pending",
                        timestamp: existingClient.timestamp || new Date().toISOString(),
                        addedBy: existingClient.addedBy || currentUser.email,
                        lastUpdatedBy: currentUser.email,
                        lastUpdateTimestamp: new Date().toISOString(),
                        isArchived: existingClient.isArchived || false,
                        visaInfo: existingClient.visaInfo || {}, // Preserve existing visaInfo if editing
                        position: existingClient.position || '', // Preserve existing position if editing
                        notes: existingClient.notes || [] // Preserve existing notes if editing
                    };

                    if (formData.visaStatus === 'visit') {
                        formData.visaInfo.daysLeft = getNumericValue('daysLeft');
                    } else if (formData.visaStatus === 'cancelled') {
                        formData.visaInfo.cancelledDate = cancelledDateInput.value;
                        formData.visaInfo.daysLeft = cancelledDateInput.value ? calculateRemainingCancelledDays(cancelledDateInput.value) : null; 
                    } else if (formData.visaStatus === 'active') {
                        const needFor = document.querySelector('input[name="needFor"]:checked')?.value;
                        formData.visaInfo.needFor = needFor;
                        if (needFor === 'yourself') formData.visaInfo.when = document.getElementById('whenDate').value;
                        else if (needFor === 'someoneElse') formData.visaInfo.forWhom = document.getElementById('forWhom').value;
                    }

                    if (formData.educationCert === 'yes') {
                        formData.position = document.getElementById('position').value;
                    } else {
                        formData.position = 'Sales Officer';
                    }
                    
                    const leadsRef = database.ref(leadsRefPath);
                    const operation = currentEditingClientId ? leadsRef.child(currentEditingClientId).update(formData) : leadsRef.push(formData);

                    operation.then(() => {
                        showToast(`Client ${currentEditingClientId ? 'updated' : 'saved'} successfully!`, true);
                        
                        // NEW: Send assignment notification if assigned user changed or it's a new assignment
                        const oldAssignedToUserEmail = existingClient.assignedToUserEmail;
                        if (newAssignedToUserEmail && (newAssignedToUserEmail !== oldAssignedToUserEmail || !currentEditingClientId)) {
                            sendAssignmentNotification(currentEditingClientId || operation.key, formData.name, newAssignedToUserEmail, currentUser.email);
                        }

                        resetForm();
                        navigateToPage('clientData');
                    }).catch(error => {
                        console.error("Firebase save error:", error);
                        showToast(`Error saving data: ${error.message}`, false);
                    }).finally(() => {
                        saveClientBtn.innerHTML = '<i class="fas fa-save"></i> Save Client';
                        saveClientBtn.disabled = false;
                    });

                } catch (error) {
                    console.error("Error in form submission logic:", error);
                    showToast(`An unexpected error occurred: ${error.message}`, false);
                    saveClientBtn.innerHTML = '<i class="fas fa-save"></i> Save Client';
                    saveClientBtn.disabled = false;
                }
            }

            // NEW: Function to send assignment notification
            async function sendAssignmentNotification(leadId, leadName, assignedToEmail, assignedByEmail) {
                const assignedUser = allUsersData.find(user => user.email === assignedToEmail);
                if (assignedUser && assignedUser.uid) {
                    // Prevent self-notification if user assigns to themselves
                    if (assignedUser.email === currentUser.email) return;

                    const notificationRef = database.ref(`${usersRefPath}/${assignedUser.uid}/assignedLeadsAnnouncements/${leadId}`);
                    try {
                        await notificationRef.set({
                            leadName: leadName,
                            assignedBy: assignedByEmail,
                            timestamp: new Date().toISOString()
                        });
                        console.log(`Assignment notification sent to ${assignedToEmail} for lead ${leadName}`);
                    } catch (error) {
                        console.error("Error sending assignment notification:", error);
                    }
                }
            }

            // NEW: Function to check and display assigned lead announcements
            async function checkAndDisplayAssignedLeadAnnouncements() {
                if (!currentUser || !currentUser.uid) return;

                const announcementsRef = database.ref(`${usersRefPath}/${currentUser.uid}/assignedLeadsAnnouncements`);
                try {
                    const snapshot = await announcementsRef.once('value');
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnap => {
                            const announcement = childSnap.val();
                            showToast(`Lead '${announcement.leadName}' has been assigned to you by ${announcement.assignedBy}!`, true);
                            childSnap.ref.remove(); // Remove notification after displaying
                        });
                    }
                } catch (error) {
                    console.error("Error checking assigned lead announcements:", error);
                }
            }
            
            function resetForm() {
                clientForm.reset();
                document.querySelectorAll('.conditional-field, #pricingSection, .info-text').forEach(el => el.classList.add('hidden'));
                if(formTitle) formTitle.setAttribute('data-lang', 'addNewLead');
                setLanguage(localStorage.getItem('language') || 'en'); 
                currentEditingClientId = null;
                cancelEditBtn.classList.add('hidden');
                clearFormBtn.classList.remove('hidden');
                saveClientBtn.disabled = false;
                if (cancelledDaysLeftInput) {
                    cancelledDaysLeftInput.value = ''; // Ensure this is cleared
                }
                // Reset dropdowns explicitly to their default empty/first option
                leadSourceSelect.value = '';
                assignedToSelect.value = ''; // Default to "Select User (Self)"
            }

            // --- WHATSAPP INTEGRATION ---
            function openWhatsApp(clientId) {
                const client = allClientsData.find(c => c.id === clientId) || archivedClientsData.find(c => c.id === clientId);
                if (!client || !client.phone) {
                    showToast("Client phone number not available.", false);
                    return;
                }

                let phoneNumber = client.phone.replace(/[^0-9]/g, ''); 
                
                // Basic UAE number formatting (adjust as needed for specific regions)
                if (phoneNumber.length > 9 && phoneNumber.startsWith('05')) {
                    phoneNumber = '9715' + phoneNumber.substring(2);
                } else if (phoneNumber.length === 9 && phoneNumber.startsWith('5')) {
                    phoneNumber = '971' + phoneNumber;
                }

                const message = `Hello ${client.name},\nI came to know you are looking for a freelance visa. \n\nYour Details:\n- Nationality: ${client.nationality}\n- Current Visa: ${client.visaStatus}`;

                const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }

            // --- RENDERING ---
            function renderClientData(clients) {
                clientsTableBody.innerHTML = '';
                const isAdminView = currentUserRole === 'admin' || currentUserRole === 'main-admin';
                const colspan = isAdminView ? 11 : 8; // Adjusted colspan for Notes, Assigned To, Last Updated columns

                if (clients.length === 0) {
                    clientsTableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 40px;">No matching leads found.</td></tr>`;
                    return;
                }
                
                clients.forEach(client => {
                    const row = clientsTableBody.insertRow();
                    row.dataset.id = client.id;
                    
                    let visaDetailsHTML = '';
                    if (client.visaStatus === 'visit') {
                        visaDetailsHTML = `<div class="visa-tag visa-visit"><i class="fas fa-plane"></i>Visit (${client.visaInfo?.daysLeft || 'N/A'} days)</div>`;
                    } else if (client.visaStatus === 'cancelled') {
                        const remainingDays = calculateRemainingCancelledDays(client.visaInfo?.cancelledDate);
                        visaDetailsHTML = `<div class="visa-tag visa-cancelled"><i class="fas fa-ban"></i>Cancelled (${remainingDays !== null ? remainingDays : 'N/A'} days left)</div>`;
                    } else if (client.visaStatus === 'active') {
                        visaDetailsHTML = `<div class="visa-tag visa-active"><i class="fas fa-check-circle"></i>Active</div>`;
                    } else {
                        visaDetailsHTML = `<div class="visa-tag status-not-visited">N/A</div>`;
                    }
                    
                    if(client.visaStatus === 'active' && client.visaInfo?.forWhom) {
                        visaDetailsHTML += `<br><small>For: ${client.visaInfo.forWhom}</small>`;
                    }

                    let certDetailsHTML = (client.educationCert === 'yes')
                        ? `<span style="color:var(--success); font-weight:bold;">Yes</span><br><small>Pos: ${client.position || 'N/A'}</small>`
                        : `<span style="color:var(--danger); font-weight:bold;">No</span>`;

                    let statusDisplayHTML = `<div class="status-badge status-${(client.status || 'pending').replace(/\s+/g, '-')}">${(client.status || 'pending')}</div>`;
                    if(isAdminView) {
                        statusDisplayHTML = `<select class="status-select" data-client-id="${client.id}">
                            <option value="pending" ${client.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="done" ${client.status === 'done' ? 'selected' : ''}>Done</option>
                            <option value="not-agreed" ${client.status === 'not-agreed' ? 'selected' : ''}>Not Agreed</option>
                            <option value="not-visited" ${client.status === 'not-visited' ? 'selected' : ''}>Not Visited</option>
                        </select>`;
                    }

                    const priorityClass = `priority-${client.priority || 'low'}`;
                    const priorityText = (client.priority || 'low').charAt(0).toUpperCase() + (client.priority || 'low').slice(1);
                    
                    const assignedToEmail = client.assignedToUserEmail || 'N/A';
                    const lastUpdatedInfo = client.lastUpdateTimestamp ? `<br><small>(${formatTimestamp(client.lastUpdateTimestamp)})</small>` : '';

                    const notesButton = `<button class="action-btn notes-btn" title="View/Add Notes" data-action="view-notes"><i class="fas fa-clipboard"></i></button>`;

                    const actionsCellHTML = isAdminView
                    ? `<td class="actions-cell">
                            ${notesButton}
                            <button class="action-btn edit-btn" title="Edit" data-action="edit"><i class="fas fa-edit"></i></button>
                            <button class="action-btn archive-btn" title="Archive" data-action="archive"><i class="fas fa-archive"></i></button>
                            <button class="action-btn gemini-btn" title="Generate WhatsApp Message" data-action="generate-whatsapp"><i class="fab fa-whatsapp"></i></button>
                            <button class="action-btn gemini-btn" title="Generate Lead Insight" data-action="generate-insight"><i class="fas fa-lightbulb"></i></button>
                        </td>`
                    : `<td>${notesButton}</td>`; // Only notes for non-admin users

                    row.innerHTML = `
                        ${isAdminView ? `<td><input type="checkbox" class="client-checkbox" data-id="${client.id}"></td>` : ''}
                        <td>
                            <strong>${client.name || 'N/A'}</strong><br>
                            <a href="#" class="whatsapp-link" data-action="whatsapp-link" data-id="${client.id}"><i class="fab fa-whatsapp"></i> ${client.phone || 'N/A'}</a>
                            ${isAdminView ? `<br><small>Source: ${client.leadSource || 'N/A'}</small>` : ''}
                        </td>
                        <td><small><strong>Nat:</strong> ${client.nationality || 'N/A'}</small><br><small><strong>Loc:</strong> ${client.location || 'N/A'}</small><br><small><strong>Visit:</strong> ${client.visitTime ? new Date(client.visitTime).toLocaleDateString() : 'N/A'}</small></td>
                        <td>${visaDetailsHTML}<br>${certDetailsHTML}</td>
                        <td><small>Comp:</small> ${client.companyPrice || 'N/A'}<br><small>Client:</small> ${client.clientQuotedPrice || 'N/A'}</td>
                        <td>${statusDisplayHTML}</td>
                        <td><div class="priority-tag ${priorityClass}">${priorityText}</div></td>
                        <td><small>${assignedToEmail}</small>${lastUpdatedInfo}</td>
                        ${actionsCellHTML}
                    `;
                });
                // Adjust header visibility for non-admin views
                document.querySelectorAll('#clientsTable th[data-lang="assignedToHeader"]').forEach(th => th.classList.toggle('hidden', !isAdminView));
                document.querySelectorAll('#clientsTable th[data-lang="lastUpdated"]').forEach(th => th.classList.toggle('hidden', !isAdminView));
                
                // Hide client checkbox header if not admin
                document.querySelectorAll('#clientsTable thead th input[type="checkbox"]').forEach(th => th.closest('th').classList.toggle('hidden', !isAdminView));
            }
            
            function renderArchivedClientData(clients) {
                archivedCardsContainer.innerHTML = '';
                const isAdminView = currentUserRole === 'admin' || currentUserRole === 'main-admin'; // Only admin can see archived data

                const searchTerm = archivedSearchInput.value.toLowerCase();
                const visaFilter = archivedFilterVisaStatus.value;
                const statusFilter = archivedFilterOverallStatus.value;

                const filteredArchivedClients = clients.filter(client => 
                    ((client.name || '').toLowerCase().includes(searchTerm) || (client.phone || '').toLowerCase().includes(searchTerm)) &&
                    (!visaFilter || client.visaStatus === visaFilter) &&
                    (!statusFilter || client.status === statusFilter)
                );


                if (filteredArchivedClients.length === 0) {
                    archivedCardsContainer.innerHTML = `<p style="text-align:center; color:var(--gray); grid-column: 1 / -1;">No matching archived leads found.</p>`;
                    return;
                }
                filteredArchivedClients.forEach(client => {
                    const archivedDate = client.archivedTimestamp ? new Date(client.archivedTimestamp).toLocaleString() : 'N/A';
                    const card = document.createElement('div');
                    card.className = 'info-card';
                    card.dataset.id = client.id; // Add data-id for event delegation
                    card.innerHTML = `
                        <div class="card-header">
                            <h4>${client.name || 'N/A'}</h4>
                            <div class="actions-cell">
                                <button class="action-btn notes-btn" title="View Notes" data-action="view-notes"><i class="fas fa-clipboard"></i></button>
                                <button class="action-btn restore-btn" title="Restore" data-action="restore"><i class="fas fa-undo"></i></button>
                                <button class="action-btn delete-btn" title="Delete Permanently" data-action="delete"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="card-body">
                            <p><strong>Phone:</strong> ${client.phone || 'N/A'}</p>
                            <p><strong>Archived by:</strong> ${client.lastUpdatedBy || 'N/A'}</p>
                            <p><strong>Archived on:</strong> ${archivedDate}</p>
                            <small><strong>Source:</strong> ${client.leadSource || 'N/A'}</small><br>
                            <small><strong>Assigned:</strong> ${client.assignedToUserEmail || 'N/A'}</small>
                        </div>
                    `;
                    archivedCardsContainer.appendChild(card);
                });
            }
            
            // --- CLIENT ACTIONS (now called directly from event delegation handlers) ---
            function editClient(clientId) {
                const isAdminView = currentUserRole === 'admin' || currentUserRole === 'main-admin';
                if (!isAdminView) {
                    showToast('You do not have permission to edit clients.', false);
                    return;
                }
                const client = [...allClientsData, ...archivedClientsData].find(c => c.id === clientId);
                if (!client) return showToast('Client not found.', false);

                document.getElementById('clientName').value = client.name || '';
                document.getElementById('phone').value = client.phone || '';
                document.getElementById('nationality').value = client.nationality || '';
                document.getElementById('location').value = client.location || '';
                document.getElementById('visaStatus').value = client.visaStatus || '';
                document.getElementById('educationCertificate').value = client.educationCert || '';
                document.getElementById('desiredSalary').value = client.salary || '';
                document.getElementById('visitTime').value = client.visitTime || '';
                document.getElementById('priority').value = client.priority || 'low';
                document.getElementById('clientQuotedPrice').value = client.clientQuotedPrice || '';
                leadSourceSelect.value = client.leadSource || ''; // New: set lead source
                assignedToSelect.value = client.assignedToUserEmail || ''; // New: set assigned user

                // Handle conditional fields and auto-calculation during edit load
                handleVisaStatusChange();
                if (client.visaStatus === 'visit') document.getElementById('daysLeft').value = client.visaInfo?.daysLeft || '';
                else if (client.visaStatus === 'cancelled') {
                    if (cancelledDateInput) {
                        cancelledDateInput.value = client.visaInfo?.cancelledDate || '';
                        // Auto-calculate for cancelled visa during edit load
                        updateCancelledDaysLeftDisplay();
                    }
                } else if (client.visaStatus === 'active' && client.visaInfo?.needFor) {
                    const radio = document.querySelector(`input[name="needFor"][value="${client.visaInfo.needFor}"]`);
                    if(radio) radio.checked = true;
                    handleActiveVisaChange();
                    if (client.visaInfo.needFor === 'yourself') document.getElementById('whenDate').value = client.visaInfo.when || '';
                    else document.getElementById('forWhom').value = client.visaInfo.forWhom || '';
                }
                
                handleEducationCertificateChange();
                if(client.educationCert === 'yes') document.getElementById('position').value = client.position || '';

                updateCompanyPrice();

                currentEditingClientId = clientId;
                formTitle.textContent = "Edit Client Lead";
                saveClientBtn.innerHTML = '<i class="fas fa-save"></i> Update Client';
                cancelEditBtn.classList.remove('hidden');
                clearFormBtn.classList.add('hidden');
                navigateToPage('addClientPanel');
            };
            
            function updateStatus(clientId, status, clientName) {
                database.ref(`${leadsRefPath}/${clientId}/status`).set(status)
                    .then(() => showToast(`Status for ${clientName} updated successfully.`, true))
                    .catch(error => {
                        console.error(`Firebase Operation Error [updateStatus]: `, error); // Log error
                        showToast(`Error updating status for ${clientName}: ${error.message}`, false);
                    });
            };

            function addClientNote() {
                const noteText = newNoteInput.value.trim();
                if (!noteText || !currentNotesClientId) {
                    showToast("Note cannot be empty or client not selected.", false);
                    return;
                }

                const clientRef = database.ref(`${leadsRefPath}/${currentNotesClientId}`);
                clientRef.transaction((currentData) => {
                    if (currentData) {
                        if (!currentData.notes) {
                            currentData.notes = [];
                        }
                        currentData.notes.push({
                            text: noteText,
                            timestamp: new Date().toISOString(),
                            addedBy: currentUser.email
                        });
                        currentData.lastUpdatedBy = currentUser.email;
                        currentData.lastUpdateTimestamp = new Date().toISOString();
                    }
                    return currentData;
                }).then(() => {
                    showToast("Note added successfully!", true);
                    newNoteInput.value = ''; // Clear input
                    // Notes modal will automatically refresh due to data listener
                }).catch(error => {
                    console.error("Error adding note:", error);
                    showToast("Error adding note: " + error.message, false);
                });
            }
            
            function deleteClient(clientId, clientName) {
                showConfirmation('Delete Permanently?', `You are about to permanently delete ${clientName}. This action cannot be undone.`, () => {
                    database.ref(`${leadsRefPath}/${clientId}`).remove()
                        .then(() => {
                            showToast("Client permanently deleted.", true);
                        })
                        .catch(error => {
                            console.error(`Firebase Operation Error [deleteClient]: `, error); // Log error
                            showToast(`Error deleting client: ${error.message}`, false);
                        });
                });
            };
            
            function archiveClient(clientId, clientName) {
                showConfirmation('Archive Lead?', `Are you sure you want to archive ${clientName}?`, () => {
                    const updateData = { 
                        isArchived: true, 
                        archivedTimestamp: new Date().toISOString(),
                        lastUpdatedBy: currentUser.email
                    };
                    database.ref(`${leadsRefPath}/${clientId}`).update(updateData)
                    .then(() => {
                        showToast(`${clientName} has been archived.`, true);
                    })
                    .catch(error => {
                        console.error(`Firebase Operation Error [archiveClient]: `, error); // Log error
                        showToast(`Error archiving client: ${error.message}`, false);
                    });
                });
            }

            function restoreClient(clientId, clientName) {
                 showConfirmation('Restore Lead?', `Are you sure you want to restore ${clientName}?`, () => {
                    const updateData = { 
                        isArchived: false, 
                        archivedTimestamp: null,
                        lastUpdatedBy: currentUser.email
                    };
                    database.ref(`${leadsRefPath}/${clientId}`).update(updateData)
                    .then(() => {
                        showToast(`${clientName} has been restored.`, true);
                    })
                    .catch(error => {
                        console.error(`Firebase Operation Error [restoreClient]: `, error); // Log error
                        showToast(`Error restoring client: ${error.message}`, false);
                    });
                });
            }
            
            async function updateCompanyPrice() {
                const nationality = nationalitySelect.value;
                const location = locationSelect.value;
                const visaStatus = visaStatusSelect.value;
                
                const priceDisplay = document.getElementById('companyPriceDisplay');
                const pricingSection = document.getElementById('pricingSection');
                const nigerianInfo = document.getElementById('nigerianVisaInfo');
                const nigerianNotAvailableInfo = document.getElementById('nigerianNotAvailableInfo');
                
                nigerianInfo.classList.add('hidden');
                nigerianNotAvailableInfo.classList.add('hidden');
                saveClientBtn.disabled = false;

                if (!nationality || !location) {
                    pricingSection.classList.add('hidden');
                    priceDisplay.textContent = translations[document.documentElement.lang]?.selectNationalityLocation || "Select nationality and location first";
                    return;
                }
                
                // Fetch prices if not already loaded or refresh needed
                if (Object.keys(companyPrices).length === 0) {
                    await loadCompanyPrices(); // Ensure prices are loaded before calculating
                }

                pricingSection.classList.remove('hidden');
                let price = 0;
                let priceText = 'N/A';

                if (nationality === 'Nigerian') {
                    if (location === 'Inside UAE' && visaStatus === 'cancelled') {
                        price = companyPrices.nigerianCancelled || 7500;
                        nigerianInfo.classList.remove('hidden');
                    } else {
                        nigerianNotAvailableInfo.classList.remove('hidden');
                        saveClientBtn.disabled = true; // Disable save if not available
                        price = 0;
                    }
                } else {
                     switch (nationality) {
                        case 'India':
                            price = (location === 'Inside UAE') ? (companyPrices.indiaInside || 7999) : (companyPrices.indiaOutside || 6999);
                            break;
                        case 'Pakistan':
                            price = (location === 'Inside UAE') ? (companyPrices.pakistanInside || 7999) : (companyPrices.pakistanOutside || 12000);
                            break;
                        case 'Other':
                            price = (location === 'Inside UAE') ? (companyPrices.otherInside || 6499) : (companyPrices.otherOutside || 5499);
                            break;
                        default: 
                            price = 0; 
                            break;
                    }
                }

                if (price > 0) {
                    priceText = `${price.toLocaleString()} AED`;
                } else if (saveClientBtn.disabled) {
                     priceText = translations[document.documentElement.lang]?.nigerianNotAvailable || 'Not Available';
                }
                
                priceDisplay.textContent = priceText;
            }

            // --- Company Price Management Functions ---
            async function loadCompanyPrices() {
                const pricesRef = database.ref(`${settingsRefPath}/companyPrices`);
                try {
                    const snapshot = await pricesRef.once('value');
                    if (snapshot.exists()) {
                        companyPrices = snapshot.val();
                        // Populate the form fields if this is the company price management section
                        if (document.getElementById('priceIndiaInside')) { // Add null checks for elements
                            document.getElementById('priceIndiaInside').value = companyPrices.indiaInside || '';
                            document.getElementById('priceIndiaOutside').value = companyPrices.indiaOutside || '';
                            document.getElementById('pricePakistanInside').value = companyPrices.pakistanInside || '';
                            document.getElementById('pricePakistanOutside').value = companyPrices.pakistanOutside || '';
                            document.getElementById('priceNigerianCancelled').value = companyPrices.nigerianCancelled || '';
                            document.getElementById('priceOtherInside').value = companyPrices.otherInside || '';
                            document.getElementById('priceOtherOutside').value = companyPrices.otherOutside || '';
                        }
                    } else {
                        companyPrices = {}; // Reset if no prices found
                    }
                }
                catch (error) {
                    console.error("Error loading company prices:", error);
                    showToast("Error loading company prices.", false);
                }
            }

            async function handleSaveCompanyPrices(e) {
                e.preventDefault();
                if (currentUserRole !== 'main-admin') {
                    showToast("You do not have permission to save prices.", false);
                    return;
                }

                savePricesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                savePricesBtn.disabled = true;

                const updatedPrices = {
                    indiaInside: parseFloat(document.getElementById('priceIndiaInside').value),
                    indiaOutside: parseFloat(document.getElementById('priceIndiaOutside').value),
                    pakistanInside: parseFloat(document.getElementById('pricePakistanInside').value),
                    pakistanOutside: parseFloat(document.getElementById('pricePakistanOutside').value),
                    nigerianCancelled: parseFloat(document.getElementById('priceNigerianCancelled').value),
                    otherInside: parseFloat(document.getElementById('priceOtherInside').value),
                    otherOutside: parseFloat(document.getElementById('priceOtherOutside').value),
                    lastUpdatedBy: currentUser.email,
                    timestamp: new Date().toISOString()
                };

                const pricesRef = database.ref(`${settingsRefPath}/companyPrices`);
                try {
                    await pricesRef.set(updatedPrices);
                    companyPrices = updatedPrices; // Update local cache
                    showToast("Company prices saved successfully!", true);
                } catch (error) {
                    console.error("Error saving company prices:", error);
                    showToast("Error saving company prices: " + error.message, false);
                } finally {
                    savePricesBtn.innerHTML = '<span data-lang="savePrices">Save Prices</span>';
                    setLanguage(localStorage.getItem('language') || 'en'); // Re-translate button text
                    savePricesBtn.disabled = false;
                }
            }


            // --- ADMIN ACTIONS ---
            function applyFilters() {
                if (!allClientsData || !searchInput) return;
                const searchTerm = searchInput.value.toLowerCase();
                const visaFilter = filterVisaStatus.value;
                const statusFilter = filterOverallStatus.value;
                const filteredClients = allClientsData.filter(client => 
                    ((client.name || '').toLowerCase().includes(searchTerm) || (client.phone || '').toLowerCase().includes(searchTerm)) &&
                    (!visaFilter || client.visaStatus === visaFilter) &&
                    (!statusFilter || client.status === statusFilter)
                );
                renderClientData(filteredClients);
            }

            function applyArchivedFilters() {
                if (!archivedClientsData || !archivedSearchInput) return; // Add null check
                const searchTerm = archivedSearchInput.value.toLowerCase();
                const visaFilter = archivedFilterVisaStatus.value;
                const statusFilter = archivedFilterOverallStatus.value;

                const filtered = archivedClientsData.filter(client =>
                    ((client.name || '').toLowerCase().includes(searchTerm) || (client.phone || '').toLowerCase().includes(searchTerm)) &&
                    (!visaFilter || client.visaStatus === visaFilter) &&
                    (!statusFilter || client.status === statusFilter)
                );
                renderArchivedClientData(filtered);
            }
            
            function handleSelectAll(e) {
                document.querySelectorAll('#clientsTable tbody .client-checkbox').forEach(cb => cb.checked = e.target.checked);
                // Only show/hide bulk delete button if any checkbox is checked
                const anyChecked = document.querySelectorAll('#clientsTable tbody .client-checkbox:checked').length > 0;
                bulkDeleteBtn.classList.toggle('hidden', !anyChecked);
            }
            
            function handleBulkArchive() {
                const selectedIds = Array.from(document.querySelectorAll('.client-checkbox:checked')).map(cb => cb.dataset.id);
                if(selectedIds.length === 0) {
                    showToast("No clients selected for archiving.", false);
                    return;
                }
                showConfirmation('Archive Selected?', `Are you sure you want to archive ${selectedIds.length} client(s)?`, () => {
                    const updates = {};
                    selectedIds.forEach(id => {
                        updates[`${leadsRefPath}/${id}/isArchived`] = true;
                        updates[`${leadsRefPath}/${id}/archivedTimestamp`] = new Date().toISOString();
                        updates[`${leadsRefPath}/${id}/lastUpdatedBy`] = currentUser.email;
                    });
                    database.ref().update(updates)
                        .then(() => {
                            showToast(`${selectedIds.length} clients archived.`, true);
                            document.getElementById('selectAllCheckbox').checked = false; // Uncheck select all
                            bulkDeleteBtn.classList.add('hidden'); // Hide bulk archive button
                        })
                        .catch(error => {
                            console.error(`Firebase Operation Error [bulkArchive]: `, error); // Log error
                            showToast(`Error archiving clients: ${error.message}`, false);
                        });
                });
            }

            function exportClientsToCsv() {
                if (!allClientsData || allClientsData.length === 0) {
                    showToast("No client data to export.", false);
                    return;
                }

                let csv = 'Client Name,Phone,Nationality,Location,Visa Status,Visa Info Days Left,Visa Info Cancelled Date,Visa Info Need For,Visa Info For Whom,Education Certificate,Position,Desired Salary,Visit Time,Company Price,Client Quoted Price,Lead Source,Assigned To,Status,Priority,Added By,Last Updated By,Last Updated Timestamp,Archived,Archived Timestamp\n';
                
                allClientsData.forEach(client => {
                    const row = [
                        `"${(client.name || '').replace(/"/g, '""')}"`,
                        `"${(client.phone || '').replace(/"/g, '""')}"`,
                        `"${(client.nationality || '').replace(/"/g, '""')}"`,
                        `"${(client.location || '').replace(/"/g, '""')}"`,
                        `"${(client.visaStatus || '').replace(/"/g, '""')}"`,
                        `"${(client.visaInfo?.daysLeft || '').toString().replace(/"/g, '""')}"`,
                        `"${(client.visaInfo?.cancelledDate || '').replace(/"/g, '""')}"`,
                        `"${(client.visaInfo?.needFor || '').replace(/"/g, '""')}"`,
                        `"${(client.visaInfo?.forWhom || '').replace(/"/g, '""')}"`,
                        `"${(client.educationCert || '').replace(/"/g, '""')}"`,
                        `"${(client.position || '').replace(/"/g, '""')}"`,
                        `"${(client.salary || '').replace(/"/g, '""')}"`,
                        `"${(client.visitTime || '').replace(/"/g, '""')}"`,
                        `"${(client.companyPrice || '').replace(/"/g, '""')}"`,
                        `"${(client.clientQuotedPrice || '').toString().replace(/"/g, '""')}"`,
                        `"${(client.leadSource || '').replace(/"/g, '""')}"`,
                        `"${(client.assignedToUserEmail || '').replace(/"/g, '""')}"`,
                        `"${(client.status || '').replace(/"/g, '""')}"`,
                        `"${(client.priority || '').replace(/"/g, '""')}"`,
                        `"${(client.addedBy || '').replace(/"/g, '""')}"`,
                        `"${(client.lastUpdatedBy || '').replace(/"/g, '""')}"`,
                        `"${(client.lastUpdateTimestamp ? formatTimestamp(client.lastUpdateTimestamp) : '').replace(/"/g, '""')}"`,
                        `"${(client.isArchived ? 'Yes' : 'No').replace(/"/g, '""')}"`,
                        `"${(client.archivedTimestamp ? formatTimestamp(client.archivedTimestamp) : '').replace(/"/g, '""')}"`
                    ];
                    csv += row.join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) { // Feature detection
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'clients_data.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast("Client data exported to CSV.", true);
                } else {
                    showToast("Your browser does not support downloading files directly.", false);
                }
            }

            async function runAutoArchive() {
                if (currentUserRole !== 'main-admin') {
                    showToast("You do not have permission to run auto-archive.", false);
                    return;
                }

                showConfirmation('Run Auto-Archive?', `This will archive leads that haven't been updated for ${autoArchiveThresholdDaysInput.value} days. Continue?`, async () => {
                    const thresholdDays = parseInt(autoArchiveThresholdDaysInput.value);
                    if (isNaN(thresholdDays) || thresholdDays <= 0) {
                        showToast("Please enter a valid number of days for auto-archive.", false);
                        return;
                    }

                    runAutoArchiveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Archiving...';
                    runAutoArchiveBtn.disabled = true;

                    const leadsToArchive = allClientsData.filter(client => {
                        if (!client.lastUpdateTimestamp) return false; // Only archive leads with an update timestamp
                        const lastUpdateDate = new Date(client.lastUpdateTimestamp);
                        const today = new Date();
                        const diffTime = today.getTime() - lastUpdateDate.getTime();
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                        return diffDays >= thresholdDays;
                    });

                    if (leadsToArchive.length === 0) {
                        showToast("No leads found to auto-archive.", true);
                        runAutoArchiveBtn.innerHTML = '<span data-lang="runAutoArchive">Run Auto-Archive Now</span>';
                        setLanguage(localStorage.getItem('language') || 'en');
                        runAutoArchiveBtn.disabled = false;
                        return;
                    }

                    const updates = {};
                    leadsToArchive.forEach(client => {
                        updates[`${leadsRefPath}/${client.id}/isArchived`] = true;
                        updates[`${leadsRefPath}/${client.id}/archivedTimestamp`] = new Date().toISOString();
                        updates[`${leadsRefPath}/${client.id}/lastUpdatedBy`] = currentUser.email;
                    });

                    try {
                        await database.ref().update(updates);
                        showToast(`${leadsToArchive.length} leads auto-archived successfully!`, true);
                    } catch (error) {
                        console.error("Error during auto-archive:", error);
                        showToast(`Error during auto-archive: ${error.message}`, false);
                    } finally {
                        runAutoArchiveBtn.innerHTML = '<span data-lang="runAutoArchive">Run Auto-Archive Now</span>';
                        setLanguage(localStorage.getItem('language') || 'en');
                        runAutoArchiveBtn.disabled = false;
                    }
                });
            }

            function loadAutoArchiveSettings() {
                // For now, only load the default threshold.
                // In a more complex app, this might load a saved setting from Firebase.
                if (autoArchiveThresholdDaysInput) {
                    autoArchiveThresholdDaysInput.value = AUTO_ARCHIVE_DEFAULT_THRESHOLD_DAYS;
                }
            }


            // --- DASHBOARD ---
            function loadDashboardData() {
                const visaCanvas = document.getElementById('visaStatusChart');
                const overallCanvas = document.getElementById('overallStatusChart');
                const leadSourceCanvas = document.getElementById('leadSourceChart');
                
                // Destroy existing charts before creating new ones to prevent memory leaks
                if (visaStatusChart) { visaStatusChart.destroy(); }
                if (overallStatusChart) { overallStatusChart.destroy(); }
                if (leadSourceChart) { leadSourceChart.destroy(); } // Destroy new chart

                if (!allClientsData) return;
                
                const activeClients = allClientsData.filter(c => !c.isArchived); // Ensure only active clients are in dashboard
                const visaStatusCounts = activeClients.reduce((acc, c) => { 
                    acc[c.visaStatus || 'unknown'] = (acc[c.visaStatus || 'unknown'] || 0) + 1; 
                    return acc; 
                }, {});
                const overallStatusCounts = activeClients.reduce((acc, c) => { 
                    acc[c.status || 'unknown'] = (acc[c.status || 'unknown'] || 0) + 1; 
                    return acc; 
                }, {});
                const leadSourceCounts = activeClients.reduce((acc, c) => {
                    acc[c.leadSource || 'unknown'] = (acc[c.leadSource || 'unknown'] || 0) + 1;
                    return acc;
                }, {});

                const chartOptions = (title) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: title, font: { size: 16 } } ,
                        legend: {
                            position: 'top',
                        },
                    }
                });

                visaStatusChart = new Chart(visaCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(visaStatusCounts),
                        datasets: [{ data: Object.values(visaStatusCounts), backgroundColor: chartColors }]
                    },
                    options: chartOptions('Leads by Visa Status')
                });

                overallStatusChart = new Chart(overallCanvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(overallStatusCounts),
                        datasets: [{ label: 'Lead Count', data: Object.values(overallStatusCounts), backgroundColor: chartColors }]
                    },
                    options: { ...chartOptions('Leads by Overall Status'), scales: { y: { beginAtZero: true } } }
                });

                leadSourceChart = new Chart(leadSourceCanvas, {
                    type: 'pie', // Pie chart for distribution
                    data: {
                        labels: Object.keys(leadSourceCounts),
                        datasets: [{ data: Object.values(leadSourceCounts), backgroundColor: chartColors }]
                    },
                    options: chartOptions('Lead Source Distribution')
                });

                // Update Personal Performance Metrics
                updatePersonalPerformanceMetrics();
            }

            function updatePersonalPerformanceMetrics() {
                if (!currentUser || !allClientsData) return;

                const userLeads = allClientsData.filter(client => client.addedBy === currentUser.email);
                const userLeadsDoneCount = userLeads.filter(client => client.status === 'done').length;
                const totalUserLeads = userLeads.length;

                const conversionRate = totalUserLeads > 0 ? ((userLeadsDoneCount / totalUserLeads) * 100).toFixed(2) : '0.00';

                if (userLeadsAdded) userLeadsAdded.textContent = totalUserLeads;
                if (userLeadsDone) userLeadsDone.textContent = userLeadsDoneCount;
                if (userConversionRate) userConversionRate.textContent = `${conversionRate}%`;
            }


            // --- USER MANAGEMENT ---
            function loadUserManagement() {
                if(currentUserRole !== 'main-admin') {
                    return; 
                }
                const tableBody = document.getElementById('userManagementTableBody');
                if (!tableBody) return; // Add null check for the table body itself
                tableBody.innerHTML = '<tr><td colspan="4"><div class="loading-spinner"></div></td></tr>';

                database.ref(usersRefPath).once('value', snapshot => {
                    tableBody.innerHTML = '';
                    if(snapshot.exists()) {
                        snapshot.forEach(childSnap => {
                            const userData = childSnap.val();
                            const uid = childSnap.key;
                            if(userData.email === MAIN_ADMIN_EMAIL) return;

                            const row = tableBody.insertRow();
                            row.dataset.uid = uid;
                            row.innerHTML = `
                                <td>${userData.email}</td>
                                <td><span class="role-badge ${userData.role}">${userData.role}</span></td>
                                <td>${formatTimestamp(userData.lastLoginAt)}</td>
                                <td class="actions-cell">
                                    <select class="status-select user-role-select" data-uid="${uid}">
                                        <option value="user" ${userData.role === 'user' ? 'selected' : ''}>User</option>
                                        <option value="manager" ${userData.role === 'manager' ? 'selected' : ''}>Manager</option>
                                        <option value="admin" ${userData.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                    <button class="action-btn delete-btn user-delete-btn" title="Delete User" data-uid="${uid}"><i class="fas fa-trash-alt"></i></button>
                                </td>
                            `;
                        });
                        tableBody.addEventListener('change', handleUserManagementChange);
                        tableBody.addEventListener('click', handleUserManagementClick);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">No users found.</td></tr>';
                    }
                }, error => {
                    console.error("Error loading user management data: ", error);
                    showToast("Error loading user data: " + error.message, false);
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--danger);">Failed to load user data.</td></tr>';
                });
            }

            // New: Load User Performance Overview
            function loadUserPerformanceOverview() {
                if (currentUserRole !== 'main-admin') {
                    return;
                }
                const tableBody = document.getElementById('userPerformanceTableBody');
                if (!tableBody) return;
                tableBody.innerHTML = '<tr><td colspan="4"><div class="loading-spinner"></div></td></tr>';

                const performanceData = {};
                allClientsData.concat(archivedClientsData).forEach(client => { // Include archived for full history
                    const email = client.addedBy;
                    if (!performanceData[email]) {
                        performanceData[email] = {
                            totalLeads: 0,
                            leadsDone: 0
                        };
                    }
                    performanceData[email].totalLeads++;
                    if (client.status === 'done') {
                        performanceData[email].leadsDone++;
                    }
                });

                tableBody.innerHTML = '';
                for (const email in performanceData) {
                    const stats = performanceData[email];
                    const conversionRate = stats.totalLeads > 0 ? ((stats.leadsDone / stats.totalLeads) * 100).toFixed(2) : '0.00';
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${email}</td>
                        <td>${stats.totalLeads}</td>
                        <td>${stats.leadsDone}</td>
                        <td>${conversionRate}%</td>
                    `;
                }
                if (Object.keys(performanceData).length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: var(--gray);">No user performance data available.</td></tr>';
                }
            }


            // Event delegation for user management table changes (role select)
            function handleUserManagementChange(event) {
                const target = event.target;
                if (target.classList.contains('user-role-select')) {
                    const uid = target.dataset.uid;
                    const newRole = target.value;
                    const userEmailForLog = target.closest('tr').querySelector('td').textContent;
                    updateUserRole(uid, newRole, userEmailForLog);
                }
            }

            // Event delegation for user management table clicks (delete user)
            function handleUserManagementClick(event) {
                const target = event.target;
                if (target.closest('.user-delete-btn')) {
                    const uid = target.closest('.user-delete-btn').dataset.uid;
                    const email = target.closest('tr').querySelector('td').textContent;
                    deleteUser(uid, email);
                }
            }

            function updateUserRole(uid, newRole, userEmailForLog) {
                if(currentUserRole !== 'main-admin') {
                    showToast("You do not have permission to update user roles.", false);
                    return;
                }
                database.ref(`${usersRefPath}/${uid}/role`).set(newRole)
                .then(() => {
                    showToast(`Role for ${userEmailForLog} updated to ${newRole}.`, true);
                    loadUserManagement(); // Re-render the list to update badges
                }).catch(err => {
                    console.error(`Firebase Operation Error [updateUserRole]: `, err); // Log error
                    showToast("Error updating user role: " + err.message, false);
                })
            }
            
            function deleteUser(uid, email) {
                if(currentUserRole !== 'main-admin') {
                    showToast("You do not have permission to delete users.", false);
                    return;
                }
                const confirmationMessage = `Are you sure you want to remove ${email}? This will permanently revoke their access to the application.`;
                showConfirmation('Delete User?', confirmationMessage, () => {
                    // This removes the user's role and permissions from the database.
                    // IMPORTANT: This does NOT delete the user from Firebase Authentication. That requires a backend Cloud Function for security reasons.
                    // However, with the check in initApp(), the user will be signed out immediately if they try to log in.
                    database.ref(`${usersRefPath}/${uid}`).remove()
                    .then(() => {
                        showToast('User deleted successfully.', true);
                        loadUserManagement(); // Refresh the user list
                    }).catch(err => {
                        console.error(`Firebase Operation Error [deleteUser]: `, err); // Log error
                        showToast(`Error deleting user: ${err.message}`, false);
                    });
                });
            }

            // --- GLOBAL ANNOUNCEMENT FUNCTIONS ---
            async function loadGlobalAnnouncement() {
                const announcementRef = database.ref(`${settingsRefPath}/globalMessage`);
                try {
                    const snapshot = await announcementRef.once('value');
                    const messageData = snapshot.val();
                    if (messageData && messageData.message) {
                        if (announcementMessageInput) announcementMessageInput.value = messageData.message;
                        if (currentAnnouncementText) currentAnnouncementText.textContent = messageData.message;
                        if (announcementLastUpdated) announcementLastUpdated.textContent = `Last updated: ${formatTimestamp(messageData.timestamp)} by ${messageData.updatedBy}`;
                    } else {
                        if (announcementMessageInput) announcementMessageInput.value = '';
                        if (currentAnnouncementText) currentAnnouncementText.textContent = translations[document.documentElement.lang]?.noCurrentAnnouncement || "No current announcement.";
                        if (announcementLastUpdated) announcementLastUpdated.textContent = '';
                    }
                } catch (error) {
                    console.error("Error loading global announcement:", error);
                    showToast("Error loading global announcement.", false);
                }
            }

            async function handleSaveGlobalAnnouncement(e) {
                e.preventDefault();
                if (currentUserRole !== 'main-admin') {
                    showToast("You do not have permission to publish announcements.", false);
                    return;
                }

                if (saveAnnouncementBtn) {
                    saveAnnouncementBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
                    saveAnnouncementBtn.disabled = true;
                }

                const message = announcementMessageInput.value.trim();
                const announcementData = {
                    message: message,
                    timestamp: new Date().toISOString(),
                    updatedBy: currentUser.email
                };

                const announcementRef = database.ref(`${settingsRefPath}/globalMessage`);
                try {
                    await announcementRef.set(announcementData);
                    showToast("Announcement published successfully!", true);
                    loadGlobalAnnouncement(); // Refresh display
                } catch (error) {
                    console.error(`Firebase Operation Error [saveAnnouncement]: `, error); // Log error
                    showToast("Error publishing announcement: " + error.message, false);
                } finally {
                    if (saveAnnouncementBtn) {
                        saveAnnouncementBtn.innerHTML = '<span data-lang="publishAnnouncement">Publish Announcement</span>';
                        setLanguage(localStorage.getItem('language') || 'en'); // Re-translate button text
                        saveAnnouncementBtn.disabled = false;
                    }
                }
            }

            async function handleClearGlobalAnnouncement() {
                if (currentUserRole !== 'main-admin') {
                    showToast("You do not have permission to clear announcements.", false);
                    return;
                }
                showConfirmation('Clear Announcement?', 'Are you sure you want to clear the global announcement?', async () => {
                    const announcementRef = database.ref(`${settingsRefPath}/globalMessage`);
                    try {
                        await announcementRef.remove();
                        showToast("Global announcement cleared.", true);
                        loadGlobalAnnouncement(); // Refresh display
                    } catch (error) {
                        console.error(`Firebase Operation Error [clearAnnouncement]: `, error); // Log error
                        showToast("Error clearing announcement: " + error.message, false);
                    }
                });
            }


            // --- GEMINI API INTEGRATION ---
            async function generateWhatsAppMessage(clientId) {
                const client = allClientsData.find(c => c.id === clientId) || archivedClientsData.find(c => c.id === clientId);
                if (!client) {
                    showToast("Client not found for message generation.", false);
                    return;
                }

                // Show loading state
                const originalButton = document.querySelector(`tr[data-id="${clientId}"] [data-action="generate-whatsapp"]`) || document.querySelector(`.info-card[data-id="${clientId}"] [data-action="generate-whatsapp"]`);
                if (!originalButton) {
                    showToast("WhatsApp button not found.", false);
                    return;
                }
                const originalHtml = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                originalButton.disabled = true;

                // Prepare visa details for the prompt
                let visaDetailString = '';
                if (client.visaStatus === 'visit') {
                    visaDetailString = `Visit Visa, with approximately ${client.visaInfo?.daysLeft || 'N/A'} days left.`;
                } else if (client.visaStatus === 'cancelled') {
                    visaDetailString = `Cancelled Visa, cancelled on ${client.visaInfo?.cancelledDate || 'N/A'}, with approximately ${calculateRemainingCancelledDays(client.visaInfo?.cancelledDate) || 'N/A'} days left for grace period.`;
                } else if (client.visaStatus === 'active') {
                    visaDetailString = `Active Visa. Needs visa for ${client.visaInfo?.needFor === 'yourself' ? 'themselves' : client.visaInfo?.forWhom || 'N/A'}.`;
                }

                const prompt = `Draft a concise, friendly, and professional WhatsApp message for a client named ${client.name}.
                Their current overall status is ${client.status || 'unknown'}.
                Nationality: ${client.nationality || 'N/A'}.
                Location: ${client.location || 'N/A'}.
                Current Visa Status: ${visaDetailString}.
                Desired Salary: ${client.salary || 'N/A'}.
                Time of Visit to Our Office: ${client.visitTime ? new Date(client.visitTime).toLocaleString() : 'N/A'}.
                
                The message should aim to re-engage them regarding their freelance visa application process.
                Start with "Hello ${client.name}," and include relevant details in a conversational tone.
                Conclude the message with "Regards,\nPlanner Zohaib\nDXB Visa Bridge".
                Do not include any placeholders like [Client Name] in the generated message.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        showWhatsAppModal(generatedText);
                    } else {
                        showToast('Failed to generate message: No content received from LLM.', false);
                        console.error('Gemini API response structure unexpected:', result);
                    }
                } catch (error) {
                    console.error(`Gemini API Error [generateWhatsAppMessage]: `, error); // Log error
                    showToast('Error generating message: ' + error.message, false);
                } finally {
                    if (originalButton) {
                        // Restore button state
                        originalButton.innerHTML = originalHtml;
                        originalButton.disabled = false;
                    }
                }
            }

            // --- NEW GEMINI FEATURE: LEAD INSIGHT ---
            async function generateLeadInsight(clientId) {
                const client = allClientsData.find(c => c.id === clientId) || archivedClientsData.find(c => c.id === clientId);
                if (!client) {
                    showToast("Client not found for lead insight generation.", false);
                    return;
                }

                // Show loading state on the specific button clicked
                const originalButton = document.querySelector(`tr[data-id="${clientId}"] [data-action="generate-insight"]`) || document.querySelector(`.info-card[data-id="${clientId}"] [data-action="generate-insight"]`);
                if (!originalButton) {
                    showToast("Lead Insight button not found.", false);
                    return;
                }
                const originalHtml = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                originalButton.disabled = true;

                // Prepare visa details for the prompt
                let visaDetailString = '';
                if (client.visaStatus === 'visit') {
                    visaDetailString = `Visit Visa, with approximately ${client.visaInfo?.daysLeft || 'N/A'} days left.`;
                } else if (client.visaStatus === 'cancelled') {
                    visaDetailString = `Cancelled Visa, cancelled on ${client.visaInfo?.cancelledDate || 'N/A'}, with approximately ${calculateRemainingCancelledDays(client.visaInfo?.cancelledDate) || 'N/A'} days left for grace period.`;
                } else if (client.visaStatus === 'active') {
                    visaDetailString = `Active Visa. Needs visa for ${client.visaInfo?.needFor === 'yourself' ? 'themselves' : client.visaInfo?.forWhom || 'N/A'}.`;
                }

                const prompt = `Analyze the following client data and provide a concise assessment of their potential as a lead for freelance visa services.
                Categorize their potential as 'High', 'Medium', or 'Low'.
                Explain the reasoning for the categorization in a few bullet points, highlighting key factors.
                Also, suggest one actionable next step for the sales agent.

                Client Name: ${client.name || 'N/A'}
                Phone: ${client.phone || 'N/A'}
                Nationality: ${client.nationality || 'N/A'}.
                Location: ${client.location || 'N/A'}.
                Current Visa Status: ${visaDetailString}.
                Attested Education Certificate: ${client.educationCert || 'N/A'}.
                Desired Salary: ${client.salary || 'N/A'}.
                Time of Visit to Our Office: ${client.visitTime ? new Date(client.visitTime).toLocaleString() : 'N/A'}.
                Overall Status: ${client.status || 'N/A'}.
                Priority: ${client.priority || 'N/A'}.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };

                try {
                    const response = await fetch(GEMINI_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        showLeadInsightModal(generatedText);
                    } else {
                        showToast('Failed to generate insight: No content received from LLM.', false);
                        console.error('Gemini API response structure unexpected:', result);
                    }
                } catch (error) {
                    console.error(`Gemini API Error [generateLeadInsight]: `, error); // Log error
                    showToast('Error generating insight: ' + error.message, false);
                } finally {
                    if (originalButton) {
                        // Restore button state
                        originalButton.innerHTML = originalHtml;
                        originalButton.disabled = false;
                    }
                }
            }


            // --- LANGUAGE SUPPORT ---
            const translations = {
                en: {
                    dashboard: "Dashboard",
                    addNewLead: "Add New Client Lead",
                    clientData: "Client Data",
                    archivedLeads: "Archived Leads",
                    settings: "Settings",
                    clientName: "Client Name",
                    phone: "Phone Number",
                    nationality: "Nationality",
                    location: "Location",
                    visaStatus: "Current Visa Status",
                    educationCertificate: "Attested Education Certificate",
                    daysLeft: "How many days left?",
                    cancelledDate: "When was it cancelled?",
                    cancelledDaysLeft: "How many days are left?",
                    needFor: "Need for yourself or someone else?",
                    forYourself: "For yourself",
                    forSomeoneElse: "For someone else",
                    when: "When?",
                    forWhom: "For whom do you need a visa?",
                    desiredSalary: "Desired Salary",
                    visitTime: "Time of Visit to Our Office",
                    position: "What position to mention on ID?",
                    salesOfficerOnly: "Only Sales Officer will be available",
                    companyPrice: "Company Price",
                    selectNationalityLocation: "Select nationality and location first",
                    quotedPrice: "Price Quoted to Client (AED)",
                    freezoneVisa: "This will be a Freezone visa.",
                    nigerianNotAvailable: "Service not available for Nigerians outside UAE or with non-cancelled visa.",
                    priority: "Priority",
                    low: "Low",
                    medium: "Medium",
                    high: "High",
                    saveClient: "Save Client",
                    clearForm: "Clear Form",
                    cancelEdit: "Cancel Edit",
                    search: "Search:",
                    visaStatusFilter: "Visa Status:",
                    overallStatusFilter: "Overall Status:",
                    archiveSelected: "Archive Selected",
                    clientContact: "Client & Contact",
                    details: "Details",
                    visaEducation: "Visa & Education",
                    pricing: "Pricing (AED)",
                    status: "Status",
                    actions: "Actions",
                    changePassword: "Change Your Password",
                    currentPassword: "Current Password",
                    newPassword: "New Password",
                    confirmNewPassword: "Confirm New Password",
                    updatePassword: "Update Password",
                    userManagement: "User Management",
                    userEmailHeader: "User Email",
                    currentRole: "Current Role",
                    lastLogin: "Last Login",
                    changeRole: "Change Role",
                    createUser: "Create New User",
                    newUserEmail: "New User's Email",
                    newUserPassword: "Password",
                    assignRole: "Assign Role",
                    createUserBtn: "Create User",
                    selectSettingFeature: "Select Feature:",
                    companyPriceManagement: "Company Price Management",
                    globalAnnouncements: "Global Announcements",
                    priceIndiaInside: "India (Inside UAE)",
                    priceIndiaOutside: "India (Outside UAE)",
                    pricePakistanInside: "Pakistan (Inside UAE)",
                    pricePakistanOutside: "Pakistan (Outside UAE)",
                    priceNigerianCancelled: "Nigerian (Cancelled Visa Inside UAE)",
                    priceOtherInside: "Other (Inside UAE)",
                    priceOtherOutside: "Other (Outside UAE)",
                    savePrices: "Save Prices",
                    announcementMessage: "Announcement Message",
                    publishAnnouncement: "Publish Announcement",
                    clearAnnouncement: "Clear Announcement",
                    currentAnnouncement: "Current Global Announcement:",
                    noCurrentAnnouncement: "No current announcement.",
                    leadSource: "Lead Source",
                    assignedTo: "Assigned To",
                    assignedToHeader: "Assigned To",
                    lastUpdated: "Last Updated",
                    exportCsv: "Export to CSV",
                    userPerformanceOverview: "User Performance Overview",
                    totalLeadsAdded: "Total Leads Added",
                    leadsDone: "Leads Done",
                    conversionRate: "Conversion Rate",
                    autoArchiveSettings: "Auto Archive Inactive Leads",
                    autoArchiveInfo: "This tool will archive leads that have not been updated for a specified number of days.",
                    archiveThresholdDays: "Archive leads older than (days):",
                    runAutoArchive: "Run Auto-Archive Now",
                },
                hi: {
                    dashboard: "डैशबोर्ड",
                    addNewLead: "नया क्लाइंट लीड जोड़ें",
                    clientData: "क्लाइंट डेटा",
                    archivedLeads: "संग्रहीत लीड्स",
                    settings: "सेटिंग्स",
                    clientName: "ग्राहक का नाम",
                    phone: "फ़ोन नंबर",
                    nationality: "राष्ट्रीयता",
                    location: "स्थान",
                    visaStatus: "वर्तमान वीज़ा स्थिति",
                    educationCertificate: "सत्यापित शिक्षा प्रमाण पत्र",
                    daysLeft: "कितने दिन बचे हैं?",
                    cancelledDate: "यह कब रद्द किया गया था?",
                    cancelledDaysLeft: "कितने दिन बचे हैं?",
                    needFor: "अपने लिए या किसी और के लिए चाहिए?",
                    forYourself: "अपने लिए",
                    forSomeoneElse: "किसी और के लिए",
                    when: "कब?",
                    forWhom: "आपको किसके लिए वीजा चाहिए?",
                    desiredSalary: "अपेक्षित वेतन",
                    visitTime: "हमारे कार्यालय में आने का समय",
                    position: "आईडी पर कौन सा पद उल्लेख करना है?",
                    salesOfficerOnly: "केवल बिक्री अधिकारी उपलब्ध होगा",
                    companyPrice: "कंपनी मूल्य",
                    selectNationalityLocation: "पहले राष्ट्रीयता और स्थान चुनें",
                    quotedPrice: "ग्राहक को बताई गई कीमत (AED)",
                    freezoneVisa: "यह एक फ्रीज़ोन वीज़ा होगा।",
                    nigerianNotAvailable: "नाइजीरियाई लोगों के लिए सेवा उपलब्ध नहीं है जो यूएई के बाहर हैं या गैर-रद्द वीजा के साथ हैं।",
                    priority: "प्राथमिकता",
                    low: "कम",
                    medium: "मध्यम",
                    high: "उच्च",
                    saveClient: "क्लाइंट सहेजें",
                    clearForm: "फ़ॉर्म साफ़ करें",
                    cancelEdit: "संपादन रद्द करें",
                    search: "खोज:",
                    visaStatusFilter: "वीज़ा स्थिति:",
                    overallStatusFilter: "समग्र स्थिति:",
                    archiveSelected: "चयनित को संग्रहीत करें",
                    clientContact: "क्लाइंट और संपर्क",
                    details: "विवरण",
                    visaEducation: "वीजा और शिक्षा",
                    pricing: "मूल्य निर्धारण (AED)",
                    status: "स्थिति",
                    actions: "कार्रवाइयां",
                    changePassword: "अपना पासवर्ड बदलें",
                    currentPassword: "वर्तमान पासवर्ड",
                    newPassword: "नया पासवर्ड",
                    confirmNewPassword: "नए पासवर्ड की पुष्टि करें",
                    updatePassword: "पासवर्ड अपडेट करें",
                    userManagement: "उपयोगकर्ता प्रबंधन",
                    userEmailHeader: "उपयोगकर्ता ईमेल",
                    currentRole: "वर्तमान भूमिका",
                    lastLogin: "अंतिम लॉगिन",
                    changeRole: "भूमिका बदलें",
                    createUser: "नया उपयोगकर्ता बनाएं",
                    newUserEmail: "नए उपयोगकर्ता का ईमेल",
                    newUserPassword: "पासवर्ड",
                    assignRole: "भूमिका सौंपें",
                    createUserBtn: "उपयोगकर्ता बनाएं",
                    selectSettingFeature: "फ़ीचर चुनें:",
                    companyPriceManagement: "कंपनी मूल्य प्रबंधन",
                    globalAnnouncements: "वैश्विक घोषणाएं",
                    priceIndiaInside: "भारत (यूएई के अंदर)",
                    priceIndiaOutside: "भारत (यूएई के बाहर)",
                    pricePakistanInside: "पाकिस्तान (यूएई के अंदर)",
                    pricePakistanOutside: "पाकिस्तान (यूएई के बाहर)",
                    priceNigerianCancelled: "नाइजीरियाई (रद्द वीज़ा यूएई के अंदर)",
                    priceOtherInside: "अन्य (यूएई के अंदर)",
                    priceOtherOutside: "अन्य (यूएई के बाहर)",
                    savePrices: "कीमतें सहेजें",
                    announcementMessage: "घोषणा संदेश",
                    publishAnnouncement: "घोषणा प्रकाशित करें",
                    clearAnnouncement: "घोषणा साफ़ करें",
                    currentAnnouncement: "वर्तमान वैश्विक घोषणा:",
                    noCurrentAnnouncement: "कोई वर्तमान घोषणा नहीं।",
                    leadSource: "लीड स्रोत",
                    assignedTo: "को सौंपा गया",
                    assignedToHeader: "को सौंपा गया",
                    lastUpdated: "अंतिम अपडेट",
                    exportCsv: "CSV में निर्यात करें",
                    userPerformanceOverview: "उपयोगकर्ता प्रदर्शन अवलोकन",
                    totalLeadsAdded: "कुल लीड जोड़े गए",
                    leadsDone: "लीड पूर्ण",
                    conversionRate: "रूपांतरण दर",
                    autoArchiveSettings: "निष्क्रिय लीड्स को स्वतः संग्रहित करें",
                    autoArchiveInfo: "यह टूल उन लीड्स को संग्रहित करेगा जिन्हें निर्दिष्ट दिनों से अपडेट नहीं किया गया है।",
                    archiveThresholdDays: "इससे पुरानी लीड्स संग्रहित करें (दिन):",
                    runAutoArchive: "अभी ऑटो-आर्काइव चलाएँ",
                },
                ar: {
                    dashboard: "لوحة التحكم",
                    addNewLead: "إضافة عميل محتمل جديد",
                    clientData: "بيانات العميل",
                    archivedLeads: "العملاء المحتملون المؤرشفون",
                    settings: "الإعدادات",
                    clientName: "اسم العميل",
                    phone: "رقم الهاتف",
                    nationality: "الجنسية",
                    location: "الموقع",
                    visaStatus: "حالة التأشيرة الحالية",
                    educationCertificate: "شهادة التعليم المصدقة",
                    daysLeft: "كم عدد الأيام المتبقية؟",
                    cancelledDate: "متى تم إلغاؤها؟",
                    cancelledDaysLeft: "كم عدد الأيام المتبقية؟",
                    needFor: "هل تحتاجها لنفسك أم لشخص آخر؟",
                    forYourself: "لنفسك",
                    forSomeoneElse: "لشخص آخر",
                    when: "متى؟",
                    forWhom: "لمن تحتاج التأشيرة؟",
                    desiredSalary: "الراتب المطلوب",
                    visitTime: "وقت زيارة مكتبنا",
                    position: "ما هو المنصب الذي يجب ذكره في الهوية؟",
                    salesOfficerOnly: "سيكون مسؤول المبيعات فقط متاحًا",
                    companyPrice: "سعر الشركة",
                    selectNationalityLocation: "الرجاء اختيار الجنسية والموقع أولاً",
                    quotedPrice: "السعر المعروض للعميل (درهم)",
                    freezoneVisa: "ستكون هذه تأشيرة منطقة حرة.",
                    nigerianNotAvailable: "الخدمة غير متوفرة للنيجيريين خارج الإمارات العربية المتحدة أو الذين لديهم تأشيرة غير ملغاة.",
                    priority: "الأولوية",
                    low: "منخفض",
                    medium: "متوسط",
                    high: "عالي",
                    saveClient: "حفظ العميل",
                    clearForm: "مسح النموذج",
                    cancelEdit: "إلغاء التعديل",
                    search: "بحث:",
                    visaStatusFilter: "حالة التأشيرة:",
                    overallStatusFilter: "الحالة العامة:",
                    archiveSelected: "أرشفة المحدد",
                    clientContact: "العميل والاتصال",
                    details: "التفاصيل",
                    visaEducation: "التأشيرة والتعليم",
                    pricing: "التسعير (درهم)",
                    status: "الحالة",
                    actions: "الإجراءات",
                    changePassword: "تغيير كلمة المرور الخاصة بك",
                    currentPassword: "كلمة المرور الحالية",
                    newPassword: "كلمة المرور الجديدة",
                    confirmNewPassword: "تأكيد كلمة المرور الجديدة",
                    updatePassword: "تحديث كلمة المرور",
                    userManagement: "إدارة المستخدمين",
                    userEmailHeader: "البريد الإلكتروني للمستخدم",
                    currentRole: "الدور الحالي",
                    lastLogin: "آخر تسجيل دخول",
                    changeRole: "تغيير الدور",
                    createUser: "إنشاء مستخدم جديد",
                    newUserEmail: "البريد الإلكتروني للمستخدم الجديد",
                    newUserPassword: "كلمة المرور",
                    assignRole: "تعيين دور",
                    createUserBtn: "إنشاء مستخدم",
                    selectSettingFeature: "تحديد الميزة:",
                    companyPriceManagement: "إدارة أسعار الشركة",
                    globalAnnouncements: "الإعلانات العالمية",
                    priceIndiaInside: "الهند (داخل الإمارات)",
                    priceIndiaOutside: "الهند (خارج الإمارات)",
                    pricePakistanInside: "باكستان (داخل الإمارات)",
                    pricePakistanOutside: "باكستان (خارج الإمارات)",
                    priceNigerianCancelled: "النيجيرية (تأشيرة ملغاة داخل الإمارات)",
                    priceOtherInside: "أخرى (داخل الإمارات)",
                    priceOtherOutside: "أخرى (خارج الإمارات)",
                    savePrices: "حفظ الأسعار",
                    announcementMessage: "رسالة الإعلان",
                    publishAnnouncement: "نشر الإعلان",
                    clearAnnouncement: "مسح الإعلان",
                    currentAnnouncement: "الإعلان العالمي الحالي:",
                    noCurrentAnnouncement: "لا يوجد إعلان حالي.",
                    leadSource: "مصدر العميل المحتمل",
                    assignedTo: "مخصص لـ",
                    assignedToHeader: "مخصص لـ",
                    lastUpdated: "آخر تحديث",
                    exportCsv: "تصدير إلى CSV",
                    userPerformanceOverview: "نظرة عامة على أداء المستخدم",
                    totalLeadsAdded: "إجمالي العملاء المحتملين المضافين",
                    leadsDone: "العملاء المحتملون المنجزون",
                    conversionRate: "معدل التحويل",
                    autoArchiveSettings: "الأرشفة التلقائية للعملاء المحتملين غير النشطين",
                    autoArchiveInfo: "ستقوم هذه الأداة بأرشفة العملاء المحتملين الذين لم يتم تحديثهم لعدد محدد من الأيام.",
                    archiveThresholdDays: "أرشفة العملاء المحتملين الأقدم من (أيام):",
                    runAutoArchive: "تشغيل الأرشفة التلقائية الآن",
                }
            };

            function setLanguage(lang) {
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
                localStorage.setItem('language', lang);
                
                // Update custom dropdown display
                const selectedOption = document.querySelector(`.language-option[data-lang-value="${lang}"]`);
                if (selectedOption) {
                    selectedLanguageText.innerHTML = `<i class="fas fa-globe"></i> ${selectedOption.querySelector('span').textContent}`;
                    document.querySelectorAll('.language-option').forEach(opt => opt.classList.remove('selected'));
                    selectedOption.classList.add('selected');
                }

                // Translate all elements with data-lang attribute
                document.querySelectorAll('[data-lang]').forEach(el => {
                    const key = el.getAttribute('data-lang');
                    if (translations[lang] && translations[lang][key]) {
                        const textSpan = el.querySelector('span');
                        if(textSpan && el.querySelector('i')) {
                            const iconHTML = el.querySelector('i').outerHTML;
                            el.innerHTML = iconHTML + ' ' + translations[lang][key];
                        } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                            el.placeholder = translations[lang][key];
                        } else {
                            el.textContent = translations[lang][key];
                        }
                    }
                });
            }
            
            // --- INITIALIZATION ---
            window.addEventListener('load', () => {
                // Assign DOM elements once the document is loaded
                loginScreen = document.getElementById('loginScreen');
                appContainer = document.getElementById('appContainer');
                loginForm = document.getElementById('loginForm');
                sidebarLinks = document.querySelectorAll('.sidebar-link');
                pages = document.querySelectorAll('.page');
                pageTitle = document.getElementById('pageTitle');
                clientForm = document.getElementById('clientForm');
                clearFormBtn = document.getElementById('clearFormBtn');
                cancelEditBtn = document.getElementById('cancelEditBtn');
                clientsTableBody = document.getElementById('clientsTable').getElementsByTagName('tbody')[0];
                archivedCardsContainer = document.getElementById('archived-cards-container');
                toast = document.getElementById('toast');
                toastMessage = document.getElementById('toastMessage');
                userAvatar = document.getElementById('userAvatar');
                userName = document.getElementById('userName');
                userEmail = document.getElementById('userEmail');
                saveClientBtn = document.getElementById('saveClientBtn');
                adminControls = document.getElementById('adminControls');
                bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                actionsHeader = document.getElementById('actionsHeader');
                formTitle = document.getElementById('formTitle');
                searchInput = document.getElementById('searchInput');
                filterVisaStatus = document.getElementById('filterVisaStatus');
                filterOverallStatus = document.getElementById('filterOverallStatus');
                changePasswordForm = document.getElementById('changePasswordForm');
                createUserForm = document.getElementById('createUserForm');
                visaStatusSelect = document.getElementById('visaStatus');
                educationCertificate = document.getElementById('educationCertificate');
                nationalitySelect = document.getElementById('nationality');
                locationSelect = document.getElementById('location');
                userProfileContainer = document.getElementById('userProfileContainer');
                profilePopover = document.getElementById('profilePopover');
                adminSettingsBtn = document.getElementById('adminSettingsBtn');
                logoutBtn = document.getElementById('logoutBtn');
                languageToggle = document.getElementById('language-toggle');
                languageOptions = document.getElementById('language-options');
                selectedLanguageText = document.getElementById('selected-language-text');
                // Elements for WhatsApp modal
                whatsappModal = document.getElementById('whatsappModal');
                generatedWhatsAppContent = document.getElementById('generatedWhatsAppContent');
                copyWhatsAppBtn = document.getElementById('copyWhatsAppBtn');
                closeWhatsAppModalBtn = document.getElementById('closeWhatsAppModalBtn');
                // Elements for new settings features (now directly referenced)
                changePasswordSection = document.getElementById('changePasswordSection');
                createUserSection = document.getElementById('createUserSection');
                userManagementSection = document.getElementById('userManagementSection');
                companyPriceManagementSection = document.getElementById('companyPriceManagementSection');
                globalAnnouncementsSection = document.getElementById('globalAnnouncementsSection');
                companyPriceForm = document.getElementById('companyPriceForm');
                savePricesBtn = document.getElementById('savePricesBtn');
                announcementBanner = document.getElementById('announcementBanner');
                announcementMessage = document.getElementById('announcementMessage');
                globalAnnouncementForm = document.getElementById('globalAnnouncementForm');
                announcementMessageInput = document.getElementById('announcementMessageInput');
                saveAnnouncementBtn = document.getElementById('saveAnnouncementBtn');
                clearAnnouncementBtn = document.getElementById('clearAnnouncementBtn');
                currentAnnouncementDisplay = document.getElementById('currentAnnouncementDisplay');
                currentAnnouncementText = document.getElementById('currentAnnouncementText');
                announcementLastUpdated = document.getElementById('announcementLastUpdated');
                // Elements for cancelled visa auto-calculation
                cancelledDateInput = document.getElementById('cancelledDate');
                cancelledDaysLeftInput = document.getElementById('cancelledDaysLeft');
                // Elements for Lead Insight modal
                leadInsightModal = document.getElementById('leadInsightModal');
                generatedLeadInsightContent = document.getElementById('generatedLeadInsightContent');
                copyLeadInsightBtn = document.getElementById('copyLeadInsightBtn');
                closeLeadInsightModalBtn = document.getElementById('closeLeadInsightModalBtn');
                // New elements for Notes modal
                notesModal = document.getElementById('notesModal');
                notesModalTitle = document.getElementById('notesModalTitle');
                notesClientName = document.getElementById('notesClientName');
                notesList = document.getElementById('notesList');
                newNoteInput = document.getElementById('newNoteInput');
                addNoteBtn = document.getElementById('addNoteBtn');
                closeNotesModalBtn = document.getElementById('closeNotesModalBtn');
                // New elements for Lead Assignment & Source
                assignedToSelect = document.getElementById('assignedTo');
                leadSourceSelect = document.getElementById('leadSource');
                exportCsvBtn = document.getElementById('exportCsvBtn');
                // New elements for Archived filters
                archivedSearchInput = document.getElementById('archivedSearchInput');
                archivedFilterVisaStatus = document.getElementById('archivedFilterVisaStatus');
                archivedFilterOverallStatus = document.getElementById('archivedFilterOverallStatus');
                archivedAdminControls = document.getElementById('archivedAdminControls');
                // New elements for User Performance Overview
                userPerformanceOverviewSection = document.getElementById('userPerformanceOverviewSection');
                userPerformanceTableBody = document.getElementById('userPerformanceTableBody');
                userLeadsAdded = document.getElementById('userLeadsAdded');
                userLeadsDone = document.getElementById('userLeadsDone');
                userConversionRate = document.getElementById('userConversionRate');
                // New elements for Auto Archive
                autoArchiveSettingsSection = document.getElementById('autoArchiveSettingsSection');
                autoArchiveThresholdDaysInput = document.getElementById('autoArchiveThresholdDays');
                runAutoArchiveBtn = document.getElementById('runAutoArchiveBtn');


                // Now initialize the app and listeners
                initApp();
                initEventListeners();
                const savedLang = localStorage.getItem('language') || 'en';
                setLanguage(savedLang);
            });
        })(); // End of IIFE
    </script>
</body>
</html>
